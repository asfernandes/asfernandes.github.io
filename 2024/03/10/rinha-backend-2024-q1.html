<!DOCTYPE html><html><head><link rel="alternate" type="application/rss+xml" title="RSS feed for blog posts" href="https://asfernandes.github.io/feed.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-7263221-3"></script><script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());

                    gtag('config', 'UA-7263221-3', {
                      page_path: window.location.pathname
                    });
                  </script><script type="text/javascript">
                    var sc_project=11098306;
                    var sc_invisible=1;
                    var sc_security='a73f5966';
                  </script><script async="" type="text/javascript" src="https://www.statcounter.com/counter/counter.js"></script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="asfernandes&#x27; blog"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous"/><title>Rinha de Backend - 2024/Q1</title><meta name="next-head-count" content="10"/><link rel="preload" href="/_next/static/css/ec84a65119aa10b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ec84a65119aa10b3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a61fb956a8c927dd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a61fb956a8c927dd.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-8c9020416d6299df.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3557c8f641e8fcfd.js" defer=""></script><script src="/_next/static/chunks/494-57da9477bc49be22.js" defer=""></script><script src="/_next/static/chunks/915-27b6902eaf029f1b.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...id%5D-896c0109065db4f8.js" defer=""></script><script src="/_next/static/QpA8urRTnSyrpC8O9BUuL/_buildManifest.js" defer=""></script><script src="/_next/static/QpA8urRTnSyrpC8O9BUuL/_ssgManifest.js" defer=""></script><script src="/_next/static/QpA8urRTnSyrpC8O9BUuL/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><header class="layout_header__kY0Lt"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">asfernandes&#x27; blog</a></div><div class="collapse navbar-collapse " id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a href="https://github.com/sponsors/asfernandes" target="_blank"><span class="fa fa-heart" style="color:red;margin-right:0.3em"></span>SPONSOR</a></li><li><a href="/contact">CONTACT</a></li><li><a href="/search" class="nav-search-link" title="Search"><span class="fa fa-search nav-search-icon"></span><span class="nav-search-text"></span></a></li></ul></div></div></nav></header><main><article><h1 class="utils_headingXl__u25Y2">Rinha de Backend - 2024/Q1</h1><div class="utils_lightText__eUzGY" style="margin-bottom:1em">Posted on <time dateTime="2024-03-10">March 10, 2024</time> in <a href="/tag/c++">c++</a>, <a href="/tag/docker">docker</a>, <a href="/tag/firebird">firebird</a>, <a href="/tag/postgresql">postgresql</a>, <a href="/tag/web">web</a></div><div><p>Hoje, dia 10/03/2024, se encerra o prazo para submissão de projetos para a
<a href="https://github.com/zanfranceschi/rinha-de-backend-2024-q1">Rinha de Backend - 2024/Q1</a>, que é a segunda edição
da Rinha de Backend. Resumindo, era preciso entregar um projeto que simule um serviço bancário com extrato e criação
de transações concorrentemente, onde as contas nunca podem ficar com saldo negativo abaixo do limite de cada
cliente. Além disso, era necessário rodar em docker, com um load balancer distribuindo a carga para no mínimo dois
serviços de API, sendo que todos os serviços juntos poderiam usar no máximo 1,5 unidades de CPU e 550MB de memória.</p>
<p>Não participei da <a href="https://github.com/zanfranceschi/rinha-de-backend-2023-q3">primeira edição em 2023</a> pois só fiquei
sabendo depois de encerrada.</p>
<p>Após essa primeira edição da Rinha de Backend, houve uma Rinha de Compiladores
(e interpretadores) onde consegui participar e <a href="https://github.com/asfernandes/rinha-de-compiler">meu projeto</a>
ficou em 9º no <a href="https://github.com/aripiprazole/rinha-de-compiler?tab=readme-ov-file#competi%C3%A7%C3%A3o">ranking</a>.</p>
<p>Um fato interessante das rinhas é que o critério do ranking final não é muito claro antecipadamente. O objetivo
é se divertir e aprender.</p>
<p>Voltando a Rinha de Backend 2024/Q1, outro ponto interessante é que para o ranking, os testes são executados
<a href="https://github.com/zanfranceschi/rinha-de-backend-2024-q1/blob/main/SPECTESTENV.md">nessa máquina</a>. Eu fiz meus testes
em duas máquinas diferentes, um desktop Ryzen 9 com 24 cores e um notebook Core i7 de 7ª geração com 4 cores. No Ryzen 9
qualquer coisa rodava muito rápido, mesmo com a limitação de CPU no docker. Algumas técnicas que melhoravam o desempenho
no desktop, pioravam no notebook. Nesses casos priorizei as técnicas que melhoravam no notebook.</p>
<p>Submeti 3 projetos construídos com uma mesma stack base:</p>
<ul>
<li><code>C++20</code> como linguagem de programação</li>
<li><code>mongoose</code> como lib http</li>
<li><code>vcpkg</code> como gerenciador de pacotes</li>
<li><code>haproxy</code> como load balancer</li>
</ul>
<p>Nos projetos usei diferentes bancos de dados e algumas alterações no código:</p>
<ul>
<li><a href="https://github.com/asfernandes/rinhaback24q1-haproxy-mongoose-pgsql">rinhaback24q1-haproxy-mongoose-pgsql</a></li>
<li><a href="https://github.com/asfernandes/rinhaback24q1-haproxy-mongoose-firebird">rinhaback24q1-haproxy-mongoose-firebird</a></li>
<li><a href="https://github.com/asfernandes/rinhaback24q1-haproxy-mongoose-lmdb">rinhaback24q1-haproxy-mongoose-lmdb</a></li>
</ul>
<h1>PostgreSQL</h1>
<p>A grande maioria dos (até então) 677 projetos usou o PostgreSQL como banco de dados. Resolvei fazer uma versão com ele
e no ranking provisório esse projeto ficou com um <strong>p75 de 1ms</strong>.</p>
<p>Ficou um projeto com um modelo de dados bastante tradicional:</p>
<div class="remark-highlight"><pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> unlogged <span class="token keyword">table</span> account <span class="token punctuation">(</span>
    id <span class="token keyword">integer</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    balance <span class="token keyword">integer</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    overdraft <span class="token keyword">integer</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> unlogged <span class="token keyword">table</span> <span class="token keyword">transaction</span> <span class="token punctuation">(</span>
    id <span class="token keyword">serial</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    account_id <span class="token keyword">integer</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    val <span class="token keyword">integer</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    description <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">datetime</span> <span class="token keyword">timestamp</span> <span class="token keyword">with</span> <span class="token keyword">time</span> zone <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">index</span> idx_transaction_account_id_id_desc <span class="token keyword">on</span> <span class="token keyword">transaction</span> <span class="token punctuation">(</span>
    account_id<span class="token punctuation">,</span>
    id <span class="token keyword">desc</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Usei 0,5 CPU e 390MB para o container do PostgreSQL, 0,2 CPU e 50MB para cada um dos dois containers de API e
0,6 CPU e 60MB para o haproxy.</p>
<p>Em cada instância da API usei um thread pool de 8 workers HTTP e um connection pool de 8 conexões para o banco de
dados. Cada request que chega pela mongoose é enviado para o thread pool e respondido de forma assíncrona.</p>
<p>A conexão com o banco foi realizada usando a <a href="https://github.com/jtv/libpqxx">libpqxx</a> por meio de Unix Domain Socket,
que se mostrou mais rápido do que TCP/IP.</p>
<p>Deixei no projeto duas views que mostram possíveis inconsistências nos dados e em nenhum teste isso aconteceu.</p>
<div class="remark-highlight"><pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> account_check
<span class="token keyword">as</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
       t<span class="token punctuation">.</span><span class="token operator">*</span>
    <span class="token keyword">from</span> account a
    <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> account_id<span class="token punctuation">,</span>
               <span class="token function">sum</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> trans_balance
            <span class="token keyword">from</span> <span class="token keyword">transaction</span>
            <span class="token keyword">group</span> <span class="token keyword">by</span> account_id
    <span class="token punctuation">)</span> t
        <span class="token keyword">on</span> t<span class="token punctuation">.</span>account_id <span class="token operator">=</span> a<span class="token punctuation">.</span>id
    <span class="token keyword">where</span> a<span class="token punctuation">.</span>balance <span class="token operator">&#x3C;</span> a<span class="token punctuation">.</span>overdraft <span class="token operator">or</span>
          <span class="token keyword">coalesce</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>trans_balance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;></span> a<span class="token punctuation">.</span>balance<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> transaction_check
<span class="token keyword">as</span>
<span class="token keyword">select</span> t<span class="token punctuation">.</span><span class="token operator">*</span>
    <span class="token keyword">from</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> id<span class="token punctuation">,</span>
               account_id<span class="token punctuation">,</span>
               <span class="token function">sum</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> account_id <span class="token keyword">order</span> <span class="token keyword">by</span> id<span class="token punctuation">)</span> balance
            <span class="token keyword">from</span> <span class="token keyword">transaction</span>
    <span class="token punctuation">)</span> t
    <span class="token keyword">join</span> account a
        <span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> t<span class="token punctuation">.</span>account_id
    <span class="token keyword">where</span> t<span class="token punctuation">.</span>balance <span class="token operator">&#x3C;</span> a<span class="token punctuation">.</span>overdraft
    <span class="token keyword">order</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span>account_id<span class="token punctuation">,</span> t<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre></div>
<h1>Firebird</h1>
<p>A versão com o Firebird também ficou com um <strong>p75 de 1ms</strong>, mas pra conseguir isso tive que inovar no modelo de dados,
pois o MVCC do Firebird não se comportou tão bem com múltiplos updates concorrentes nos mesmos registros para atualizar
o saldo. Interessante é que esse problema de performance só aconteceu no notebook. No desktop, mesmo usando um modelo
tradicional o desempenho foi bom.</p>
<p>Assim ficou o modelo:</p>
<div class="remark-highlight"><pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">transaction</span> <span class="token punctuation">(</span>
    account_id <span class="token keyword">integer</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    seq <span class="token keyword">integer</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    balance <span class="token keyword">integer</span> <span class="token comment">/*not null*/</span><span class="token punctuation">,</span>
    overdraft <span class="token keyword">integer</span> <span class="token comment">/*not null*/</span><span class="token punctuation">,</span>
    val <span class="token keyword">integer</span> <span class="token comment">/*not null*/</span><span class="token punctuation">,</span>
    description <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">/*not null*/</span><span class="token punctuation">,</span>
    <span class="token keyword">datetime</span> <span class="token keyword">timestamp</span> <span class="token keyword">with</span> <span class="token keyword">time</span> zone <span class="token comment">/*not null*/</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> transaction_pk <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>account_id<span class="token punctuation">,</span> seq<span class="token punctuation">)</span> <span class="token keyword">using</span> <span class="token keyword">desc</span> <span class="token keyword">index</span> transaction_pk_desc
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Com uma stored procedure PSQL usando vários recursos interessantes do Firebird, foi possível resolver todos os problemas
de concorrência dessa forma:</p>
<div class="remark-highlight"><pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">alter</span> <span class="token keyword">procedure</span> post_transaction<span class="token punctuation">(</span>
    account_id <span class="token keyword">integer</span><span class="token punctuation">,</span>
    val <span class="token keyword">integer</span><span class="token punctuation">,</span>
    description <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>
    status_code <span class="token keyword">integer</span><span class="token punctuation">,</span>
    balance <span class="token keyword">integer</span><span class="token punctuation">,</span>
    overdraft <span class="token keyword">integer</span>
<span class="token punctuation">)</span>
<span class="token keyword">as</span>
<span class="token keyword">begin</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">begin</span>
        <span class="token comment">/*</span>
<span class="token comment">        If this does not raise exception, it means one of these:</span>
<span class="token comment">        - the transaction succeded (status_code = 200)</span>
<span class="token comment">        - bankrupt (only when val &#x3C; 0)</span>
<span class="token comment">        - account does not exists</span>
<span class="token comment">        */</span>
        <span class="token operator">in</span> autonomous <span class="token keyword">transaction</span> <span class="token keyword">do</span>
            <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">transaction</span> <span class="token punctuation">(</span>account_id<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> balance<span class="token punctuation">,</span> overdraft<span class="token punctuation">,</span> val<span class="token punctuation">,</span> description<span class="token punctuation">,</span> <span class="token keyword">datetime</span><span class="token punctuation">)</span>
                <span class="token keyword">select</span> :account_id<span class="token punctuation">,</span>
                       seq <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                       new_balance<span class="token punctuation">,</span>
                       overdraft<span class="token punctuation">,</span>
                       :val<span class="token punctuation">,</span>
                       :description<span class="token punctuation">,</span>
                       <span class="token string">'now'</span>   <span class="token comment">-- with current_timestamp it will be fixed during the whole execution</span>
                    <span class="token keyword">from</span> <span class="token punctuation">(</span>
                        <span class="token keyword">select</span> seq<span class="token punctuation">,</span>
                               balance <span class="token operator">+</span> :val new_balance<span class="token punctuation">,</span>
                               overdraft
                            <span class="token keyword">from</span> <span class="token keyword">transaction</span>
                            <span class="token keyword">where</span> account_id <span class="token operator">=</span> :account_id
                            <span class="token keyword">order</span> <span class="token keyword">by</span> seq <span class="token keyword">desc</span>
                            <span class="token keyword">rows</span> <span class="token number">1</span>
                    <span class="token punctuation">)</span>
                    <span class="token keyword">where</span> new_balance <span class="token operator">>=</span> overdraft
                <span class="token keyword">returning</span> <span class="token number">200</span><span class="token punctuation">,</span> balance<span class="token punctuation">,</span> overdraft
                <span class="token keyword">into</span> status_code<span class="token punctuation">,</span> balance<span class="token punctuation">,</span> overdraft<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>status_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
            status_code <span class="token operator">=</span>
                <span class="token keyword">case</span>
                    <span class="token keyword">when</span> val <span class="token operator">&#x3C;</span> <span class="token number">0</span> <span class="token keyword">then</span>
                        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>
                            <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">422</span>  <span class="token comment">-- account exists, so it is bankrupt</span>
                                 <span class="token keyword">from</span> <span class="token keyword">transaction</span>
                                 <span class="token keyword">where</span> account_id <span class="token operator">=</span> :account_id <span class="token operator">and</span>
                                       seq <span class="token operator">=</span> <span class="token number">0</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token number">404</span>  <span class="token comment">-- account does not exists</span>
                        <span class="token punctuation">)</span>
                    <span class="token keyword">else</span> <span class="token number">404</span>  <span class="token comment">-- account does not exists</span>
                <span class="token keyword">end</span><span class="token punctuation">;</span>

        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token keyword">when</span> gdscode unique_key_violation <span class="token keyword">do</span>
        <span class="token comment">/*</span>
<span class="token comment">        Here we know the account exist.</span>
<span class="token comment">        If the insert do not raise exception in the next round, it will overwrite status_code with 200</span>
<span class="token comment">        or it will leave the status code as 422 meaning the account is bankrupt.</span>
<span class="token comment">        */</span>
        status_code <span class="token operator">=</span> <span class="token number">422</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div>
<p>Como a tabela <code>transaction</code> tem uma primary key em <code>(account_id, seq)</code> e a busca da próxima sequencia é feita
incrementando o valor da última sequencia (comitada) da conta, quando mais de uma tentativa de inserção de transação
para uma conta é feita simultaneamente, só a primeira passa e as outras geram um erro de violação de chave primária.</p>
<p>Quando esse erro acontece, o loop é reiniciado e uma nova transação é iniciada, podendo ler os últimos dados
comitados pelas transações concorrentes já finalizadas.</p>
<p>Usei 0,5 CPU e 390MB para o container do Firebird, 0,2 CPU e 50MB para cada um dos dois containers de API e
0,6 CPU e 60MB para o haproxy. Idêntico ao projeto com PostgreSQL.</p>
<p>Mas as similaridades param aí. O Firebird ainda não tem conexão via Unix Domain Socket, então usei TCP/IP com a API OO
nativa do Firebird.</p>
<p>Usei 8 workers HTTP em cada container API de forma bastante diferente do que fiz com o projeto do PostgreSQL.
Todos os threads iniciam conexões de escuta na mesma porta (usando a flag <code>SO_REUSEPORT</code>).
Cada thread possui uma conexão dedicada ao Firebird usando TLS (<code>thread_local</code>).
Dessa forma foi possível usar a mongoose de forma síncrona.</p>
<p>Deixei no projeto uma view que mostra possíveis inconsistências nos dados e em nenhum teste isso aconteceu.</p>
<div class="remark-highlight"><pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">alter</span> <span class="token keyword">view</span> transaction_check
<span class="token keyword">as</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token keyword">from</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> t<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
               <span class="token function">sum</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> account_id <span class="token keyword">order</span> <span class="token keyword">by</span> seq<span class="token punctuation">)</span> calc_balance
            <span class="token keyword">from</span> <span class="token keyword">transaction</span> t
    <span class="token punctuation">)</span>
    <span class="token keyword">where</span> balance <span class="token operator">&#x3C;</span> overdraft <span class="token operator">or</span>
          calc_balance <span class="token operator">&#x3C;></span> balance
    <span class="token keyword">order</span> <span class="token keyword">by</span> account_id<span class="token punctuation">,</span> seq<span class="token punctuation">;</span>
</code></pre></div>
<h1>LMDB</h1>
<p>Queria fazer uma versão com um banco de dados chave/valor que conseguisse compartilhar o banco de dados em diferentes
processos sem necessidade de usar um container específico. Descobri o LMDB, ou Lightning Memory-Mapped Database.</p>
<p>O LMDB mapeia um arquivo de disco em memória (<code>mmap</code>) e pode ser usado simultaneamente por diferentes processos.</p>
<p>A versão com o LMDB ficou com um <strong>p75 de 0ms</strong>.</p>
<p>Defini o modelo com uma chave com o código da conta e os dados como abaixo:</p>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">TransactionData</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> reverseSeq<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token class-name">int64_t</span> dateTime<span class="token punctuation">;</span>
	std<span class="token operator">::</span>array<span class="token operator">&#x3C;</span><span class="token keyword">char</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token operator">></span> description<span class="token punctuation">;</span>
	<span class="token keyword">int</span> value<span class="token punctuation">;</span>
	<span class="token keyword">int</span> balance<span class="token punctuation">;</span>
	<span class="token keyword">int</span> overdraft<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Precisei adicionar uma chave <code>reverseSeq</code> que é uma auto-decrement para os registros ficarem ordenados iniciando pelos
últimos inseridos. Apesar do LMDB ser transacional, para gerar essa chave de forma única, criei um mutex compartilhado
(<code>boost::interprocess::named_mutex</code>) entre os dois containers de API. Pra isso foi necessário colocá-los no mesmo
<code>pid namespace</code> do docker.</p>
<p>Usei 0,4 CPU e 150MB para cada um dos dois containers de API e 0,7 CPU e 150MB para o haproxy.
A mongoose foi usada como no Firebird, com <code>SO_REUSEPORT</code>. O LMDB permite (e requer) que apenas uma conexão seja feita
para cada banco de dados em um mesmo processo.</p>
<h1>Uma técnica interessante</h1>
<p>Cheguei a testar uma técnica interessante que mostrou ter um desempenho muito bom, mas com alguns picos que
atrapalhavam. Não debuguei o problema e não coloquei em nenhum dos projetos.</p>
<p>A técnica foi criar um load balancer próprio com a mongoose e repassar os sockets abertos para as APIs responderem
diretamente aos clientes, sem rotear as respostas usando o load balancer. Essa técnica é chamada socket takeover e
foi detalhada
<a href="https://copyconstruct.medium.com/file-descriptor-transfer-over-unix-domain-sockets-dcbbf5b3b6ec">aqui</a>,
embora com motivação diferente.</p>
<h1>A ideia inicial</h1>
<p>Inicialmente minha ideia era desenvolver a API usando GRPC e colocar o <a href="https://www.envoyproxy.io/">envoy</a> como
load balancer fazendo a conversão de HTTP para GRPC. Isso até foi possível usando
<a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/grpc_json_transcoder_filter">esse filtro</a>,
com algumas dificuldades de conversão de respostas GRPC para status code HTTP nos casos de erros, onde foi necessário
usar scrips LUA. Porém o desempenho não foi bom.</p>
<h1>Curiosidades</h1>
<ul>
<li>A mongoose não suporta o uso de <code>SO_REUSEPORT</code> mas se tiver um <code>#define</code> com o nome <code>SO_EXCLUSIVEADDRUSE</code> ela
seta essa flag nos sockets. Como esse define não existe no Linux, criei um <code>triplet vcpkg</code> e um <code>toolchain cmake</code>
para passar <code>SO_REUSEPORT</code> no lugar:</li>
</ul>
<div class="remark-highlight"><pre class="language-cmake"><code class="language-cmake"><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_C_FLAGS</span> <span class="token string">"-DSO_EXCLUSIVEADDRUSE=SO_REUSEPORT"</span><span class="token punctuation">)</span>
</code></pre></div>
<ul>
<li>
<p>Usei o <code>haproxy</code> no modo <code>tcp</code> para ter o mínimo overhead possível</p>
</li>
<li>
<p>Usei o gerenciador de memória <a href="https://github.com/microsoft/mimalloc">mimalloc</a> da Microsoft para economizar
alguns ciclos de CPU</p>
</li>
<li>
<p>A função <code>mg_match</code> da mongoose foi mais rápida do que deixar uma regex C++ pré-compilada</p>
</li>
<li>
<p><code>std::format_to_n</code> foi mais rápida que <code>sprintf</code></p>
</li>
<li>
<p><code>g++</code> (com <code>libstdc++</code>) foi mais rapido que <code>clang++</code> com <code>libstdc++</code> e <code>libc++</code></p>
</li>
<li>
<p>Usando a experiência que adquiriram na rinha de 2023, usei <code>network_mode: host</code> em todos os containers, embora nas
minhas máquinas não tenha tido vantagens</p>
</li>
</ul>
</div></article><div class="utils_socialButtons__oMV54"><button aria-label="facebook" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="whatsapp" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#25D366"></circle><path d="m42.32286,33.93287c-0.5178,-0.2589 -3.04726,-1.49644 -3.52105,-1.66732c-0.4712,-0.17346 -0.81554,-0.2589 -1.15987,0.2589c-0.34175,0.51004 -1.33075,1.66474 -1.63108,2.00648c-0.30032,0.33658 -0.60064,0.36247 -1.11327,0.12945c-0.5178,-0.2589 -2.17994,-0.80259 -4.14759,-2.56312c-1.53269,-1.37217 -2.56312,-3.05503 -2.86603,-3.57283c-0.30033,-0.5178 -0.03366,-0.80259 0.22524,-1.06149c0.23301,-0.23301 0.5178,-0.59547 0.7767,-0.90616c0.25372,-0.31068 0.33657,-0.5178 0.51262,-0.85437c0.17088,-0.36246 0.08544,-0.64725 -0.04402,-0.90615c-0.12945,-0.2589 -1.15987,-2.79613 -1.58964,-3.80584c-0.41424,-1.00971 -0.84142,-0.88027 -1.15987,-0.88027c-0.29773,-0.02588 -0.64208,-0.02588 -0.98382,-0.02588c-0.34693,0 -0.90616,0.12945 -1.37736,0.62136c-0.4712,0.5178 -1.80194,1.76053 -1.80194,4.27186c0,2.51134 1.84596,4.945 2.10227,5.30747c0.2589,0.33657 3.63497,5.51458 8.80262,7.74113c1.23237,0.5178 2.1903,0.82848 2.94111,1.08738c1.23237,0.38836 2.35599,0.33657 3.24402,0.20712c0.99159,-0.15534 3.04985,-1.24272 3.47963,-2.45956c0.44013,-1.21683 0.44013,-2.22654 0.31068,-2.45955c-0.12945,-0.23301 -0.46601,-0.36247 -0.98382,-0.59548m-9.40068,12.84407l-0.02589,0c-3.05503,0 -6.08417,-0.82849 -8.72495,-2.38189l-0.62136,-0.37023l-6.47252,1.68286l1.73463,-6.29129l-0.41424,-0.64725c-1.70875,-2.71846 -2.6149,-5.85116 -2.6149,-9.07706c0,-9.39809 7.68934,-17.06155 17.15993,-17.06155c4.58253,0 8.88029,1.78642 12.11655,5.02268c3.23625,3.21036 5.02267,7.50812 5.02267,12.06476c-0.0078,9.3981 -7.69712,17.06155 -17.14699,17.06155m14.58906,-31.58846c-3.93529,-3.80584 -9.1133,-5.95471 -14.62789,-5.95471c-11.36055,0 -20.60848,9.2065 -20.61625,20.52564c0,3.61684 0.94757,7.14565 2.75211,10.26282l-2.92557,10.63564l10.93337,-2.85309c3.0136,1.63108 6.4052,2.4958 9.85634,2.49839l0.01037,0c11.36574,0 20.61884,-9.2091 20.62403,-20.53082c0,-5.48093 -2.14111,-10.64081 -6.03239,-14.51915" fill="white"></path></svg></button><button aria-label="linkedin" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button><button aria-label="email" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#7f7f7f"></circle><path d="M17,22v20h30V22H17z M41.1,25L32,32.1L22.9,25H41.1z M20,39V26.6l12,9.3l12-9.3V39H20z" fill="white"></path></svg></button></div><div id="disqus_thread"></div></main><div class="layout_backToHome__9sjx_"><a href="/">← Back to home</a></div></div><footer class="layout_footer__dka_2"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/sponsors/asfernandes" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://twitter.com/adrianosf" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href="mailto:adrianosf@gmail.com" title="E-mail me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://linkedin.com/in/adrianosf" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://asfernandes.github.io/feed.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="layout_copyright__3e0Cv text-center text-muted">Copyright © Adriano dos Santos Fernandes</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2024","03","10","rinha-backend-2024-q1"],"contentHtml":"\u003cp\u003eHoje, dia 10/03/2024, se encerra o prazo para submissão de projetos para a\n\u003ca href=\"https://github.com/zanfranceschi/rinha-de-backend-2024-q1\"\u003eRinha de Backend - 2024/Q1\u003c/a\u003e, que é a segunda edição\nda Rinha de Backend. Resumindo, era preciso entregar um projeto que simule um serviço bancário com extrato e criação\nde transações concorrentemente, onde as contas nunca podem ficar com saldo negativo abaixo do limite de cada\ncliente. Além disso, era necessário rodar em docker, com um load balancer distribuindo a carga para no mínimo dois\nserviços de API, sendo que todos os serviços juntos poderiam usar no máximo 1,5 unidades de CPU e 550MB de memória.\u003c/p\u003e\n\u003cp\u003eNão participei da \u003ca href=\"https://github.com/zanfranceschi/rinha-de-backend-2023-q3\"\u003eprimeira edição em 2023\u003c/a\u003e pois só fiquei\nsabendo depois de encerrada.\u003c/p\u003e\n\u003cp\u003eApós essa primeira edição da Rinha de Backend, houve uma Rinha de Compiladores\n(e interpretadores) onde consegui participar e \u003ca href=\"https://github.com/asfernandes/rinha-de-compiler\"\u003emeu projeto\u003c/a\u003e\nficou em 9º no \u003ca href=\"https://github.com/aripiprazole/rinha-de-compiler?tab=readme-ov-file#competi%C3%A7%C3%A3o\"\u003eranking\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eUm fato interessante das rinhas é que o critério do ranking final não é muito claro antecipadamente. O objetivo\né se divertir e aprender.\u003c/p\u003e\n\u003cp\u003eVoltando a Rinha de Backend 2024/Q1, outro ponto interessante é que para o ranking, os testes são executados\n\u003ca href=\"https://github.com/zanfranceschi/rinha-de-backend-2024-q1/blob/main/SPECTESTENV.md\"\u003enessa máquina\u003c/a\u003e. Eu fiz meus testes\nem duas máquinas diferentes, um desktop Ryzen 9 com 24 cores e um notebook Core i7 de 7ª geração com 4 cores. No Ryzen 9\nqualquer coisa rodava muito rápido, mesmo com a limitação de CPU no docker. Algumas técnicas que melhoravam o desempenho\nno desktop, pioravam no notebook. Nesses casos priorizei as técnicas que melhoravam no notebook.\u003c/p\u003e\n\u003cp\u003eSubmeti 3 projetos construídos com uma mesma stack base:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eC++20\u003c/code\u003e como linguagem de programação\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emongoose\u003c/code\u003e como lib http\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evcpkg\u003c/code\u003e como gerenciador de pacotes\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehaproxy\u003c/code\u003e como load balancer\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eNos projetos usei diferentes bancos de dados e algumas alterações no código:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/asfernandes/rinhaback24q1-haproxy-mongoose-pgsql\"\u003erinhaback24q1-haproxy-mongoose-pgsql\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/asfernandes/rinhaback24q1-haproxy-mongoose-firebird\"\u003erinhaback24q1-haproxy-mongoose-firebird\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/asfernandes/rinhaback24q1-haproxy-mongoose-lmdb\"\u003erinhaback24q1-haproxy-mongoose-lmdb\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003ePostgreSQL\u003c/h1\u003e\n\u003cp\u003eA grande maioria dos (até então) 677 projetos usou o PostgreSQL como banco de dados. Resolvei fazer uma versão com ele\ne no ranking provisório esse projeto ficou com um \u003cstrong\u003ep75 de 1ms\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFicou um projeto com um modelo de dados bastante tradicional:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e unlogged \u003cspan class=\"token keyword\"\u003etable\u003c/span\u003e account \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    id \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eprimary\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ekey\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    balance \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    overdraft \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e unlogged \u003cspan class=\"token keyword\"\u003etable\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    id \u003cspan class=\"token keyword\"\u003eserial\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    account_id \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    val \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    description \u003cspan class=\"token keyword\"\u003evarchar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003edatetime\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etime\u003c/span\u003e zone \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eindex\u003c/span\u003e idx_transaction_account_id_id_desc \u003cspan class=\"token keyword\"\u003eon\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    account_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    id \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eUsei 0,5 CPU e 390MB para o container do PostgreSQL, 0,2 CPU e 50MB para cada um dos dois containers de API e\n0,6 CPU e 60MB para o haproxy.\u003c/p\u003e\n\u003cp\u003eEm cada instância da API usei um thread pool de 8 workers HTTP e um connection pool de 8 conexões para o banco de\ndados. Cada request que chega pela mongoose é enviado para o thread pool e respondido de forma assíncrona.\u003c/p\u003e\n\u003cp\u003eA conexão com o banco foi realizada usando a \u003ca href=\"https://github.com/jtv/libpqxx\"\u003elibpqxx\u003c/a\u003e por meio de Unix Domain Socket,\nque se mostrou mais rápido do que TCP/IP.\u003c/p\u003e\n\u003cp\u003eDeixei no projeto duas views que mostram possíveis inconsistências nos dados e em nenhum teste isso aconteceu.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e \u003cspan class=\"token operator\"\u003eor\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereplace\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eview\u003c/span\u003e account_check\n\u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n       t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e account a\n    \u003cspan class=\"token keyword\"\u003eleft\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ejoin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e account_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n               \u003cspan class=\"token function\"\u003esum\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eval\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e trans_balance\n            \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003egroup\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e account_id\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e t\n        \u003cspan class=\"token keyword\"\u003eon\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eaccount_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\n    \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebalance \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eoverdraft \u003cspan class=\"token operator\"\u003eor\u003c/span\u003e\n          \u003cspan class=\"token keyword\"\u003ecoalesce\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrans_balance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003e\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebalance\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e \u003cspan class=\"token operator\"\u003eor\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereplace\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eview\u003c/span\u003e transaction_check\n\u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n               account_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n               \u003cspan class=\"token function\"\u003esum\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eval\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eover\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003epartition\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e account_id \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e balance\n            \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e t\n    \u003cspan class=\"token keyword\"\u003ejoin\u003c/span\u003e account a\n        \u003cspan class=\"token keyword\"\u003eon\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eaccount_id\n    \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebalance \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eoverdraft\n    \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eaccount_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eFirebird\u003c/h1\u003e\n\u003cp\u003eA versão com o Firebird também ficou com um \u003cstrong\u003ep75 de 1ms\u003c/strong\u003e, mas pra conseguir isso tive que inovar no modelo de dados,\npois o MVCC do Firebird não se comportou tão bem com múltiplos updates concorrentes nos mesmos registros para atualizar\no saldo. Interessante é que esse problema de performance só aconteceu no notebook. No desktop, mesmo usando um modelo\ntradicional o desempenho foi bom.\u003c/p\u003e\n\u003cp\u003eAssim ficou o modelo:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etable\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    account_id \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    seq \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token operator\"\u003enot\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    balance \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token comment\"\u003e/*not null*/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    overdraft \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token comment\"\u003e/*not null*/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    val \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e \u003cspan class=\"token comment\"\u003e/*not null*/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    description \u003cspan class=\"token keyword\"\u003evarchar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e/*not null*/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003edatetime\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etime\u003c/span\u003e zone \u003cspan class=\"token comment\"\u003e/*not null*/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econstraint\u003c/span\u003e transaction_pk \u003cspan class=\"token keyword\"\u003eprimary\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ekey\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccount_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e seq\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eindex\u003c/span\u003e transaction_pk_desc\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eCom uma stored procedure PSQL usando vários recursos interessantes do Firebird, foi possível resolver todos os problemas\nde concorrência dessa forma:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e \u003cspan class=\"token operator\"\u003eor\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ealter\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eprocedure\u003c/span\u003e post_transaction\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    account_id \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    val \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    description \u003cspan class=\"token keyword\"\u003evarchar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturns\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    status_code \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    balance \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    overdraft \u003cspan class=\"token keyword\"\u003einteger\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ebegin\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ebegin\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e/*\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        If this does not raise exception, it means one of these:\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        - the transaction succeded (status_code = 200)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        - bankrupt (only when val \u0026#x3C; 0)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        - account does not exists\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        */\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003ein\u003c/span\u003e autonomous \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003einsert\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einto\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccount_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e seq\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e balance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e overdraft\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e val\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e description\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edatetime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e :account_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                       seq \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                       new_balance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                       overdraft\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                       :val\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                       :description\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                       \u003cspan class=\"token string\"\u003e'now'\u003c/span\u003e   \u003cspan class=\"token comment\"\u003e-- with current_timestamp it will be fixed during the whole execution\u003c/span\u003e\n                    \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                        \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e seq\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                               balance \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e :val new_balance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                               overdraft\n                            \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e\n                            \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e account_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e :account_id\n                            \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e seq \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e\n                            \u003cspan class=\"token keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n                    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e new_balance \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e overdraft\n                \u003cspan class=\"token keyword\"\u003ereturning\u003c/span\u003e \u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e balance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e overdraft\n                \u003cspan class=\"token keyword\"\u003einto\u003c/span\u003e status_code\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e balance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e overdraft\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus_code \u003cspan class=\"token operator\"\u003eis\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n            status_code \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e\n                    \u003cspan class=\"token keyword\"\u003ewhen\u003c/span\u003e val \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n                        \u003cspan class=\"token keyword\"\u003ecoalesce\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                            \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token number\"\u003e422\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e-- account exists, so it is bankrupt\u003c/span\u003e\n                                 \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e\n                                 \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e account_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e :account_id \u003cspan class=\"token operator\"\u003eand\u003c/span\u003e\n                                       seq \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n                            \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                            \u003cspan class=\"token number\"\u003e404\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e-- account does not exists\u003c/span\u003e\n                        \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token number\"\u003e404\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e-- account does not exists\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003eexit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhen\u003c/span\u003e gdscode unique_key_violation \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e/*\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        Here we know the account exist.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        If the insert do not raise exception in the next round, it will overwrite status_code with 200\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        or it will leave the status code as 422 meaning the account is bankrupt.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        */\u003c/span\u003e\n        status_code \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e422\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eComo a tabela \u003ccode\u003etransaction\u003c/code\u003e tem uma primary key em \u003ccode\u003e(account_id, seq)\u003c/code\u003e e a busca da próxima sequencia é feita\nincrementando o valor da última sequencia (comitada) da conta, quando mais de uma tentativa de inserção de transação\npara uma conta é feita simultaneamente, só a primeira passa e as outras geram um erro de violação de chave primária.\u003c/p\u003e\n\u003cp\u003eQuando esse erro acontece, o loop é reiniciado e uma nova transação é iniciada, podendo ler os últimos dados\ncomitados pelas transações concorrentes já finalizadas.\u003c/p\u003e\n\u003cp\u003eUsei 0,5 CPU e 390MB para o container do Firebird, 0,2 CPU e 50MB para cada um dos dois containers de API e\n0,6 CPU e 60MB para o haproxy. Idêntico ao projeto com PostgreSQL.\u003c/p\u003e\n\u003cp\u003eMas as similaridades param aí. O Firebird ainda não tem conexão via Unix Domain Socket, então usei TCP/IP com a API OO\nnativa do Firebird.\u003c/p\u003e\n\u003cp\u003eUsei 8 workers HTTP em cada container API de forma bastante diferente do que fiz com o projeto do PostgreSQL.\nTodos os threads iniciam conexões de escuta na mesma porta (usando a flag \u003ccode\u003eSO_REUSEPORT\u003c/code\u003e).\nCada thread possui uma conexão dedicada ao Firebird usando TLS (\u003ccode\u003ethread_local\u003c/code\u003e).\nDessa forma foi possível usar a mongoose de forma síncrona.\u003c/p\u003e\n\u003cp\u003eDeixei no projeto uma view que mostra possíveis inconsistências nos dados e em nenhum teste isso aconteceu.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003ecreate\u003c/span\u003e \u003cspan class=\"token operator\"\u003eor\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ealter\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eview\u003c/span\u003e transaction_check\n\u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n               \u003cspan class=\"token function\"\u003esum\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eval\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eover\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003epartition\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e account_id \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e seq\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e calc_balance\n            \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e t\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e balance \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e overdraft \u003cspan class=\"token operator\"\u003eor\u003c/span\u003e\n          calc_balance \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003e\u003c/span\u003e balance\n    \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e account_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e seq\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1\u003eLMDB\u003c/h1\u003e\n\u003cp\u003eQueria fazer uma versão com um banco de dados chave/valor que conseguisse compartilhar o banco de dados em diferentes\nprocessos sem necessidade de usar um container específico. Descobri o LMDB, ou Lightning Memory-Mapped Database.\u003c/p\u003e\n\u003cp\u003eO LMDB mapeia um arquivo de disco em memória (\u003ccode\u003emmap\u003c/code\u003e) e pode ser usado simultaneamente por diferentes processos.\u003c/p\u003e\n\u003cp\u003eA versão com o LMDB ficou com um \u003cstrong\u003ep75 de 0ms\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eDefini o modelo com uma chave com o código da conta e os dados como abaixo:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token keyword\"\u003e__attribute__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epacked\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionData\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003euint8_t\u003c/span\u003e reverseSeq\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eint64_t\u003c/span\u003e dateTime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\tstd\u003cspan class=\"token operator\"\u003e::\u003c/span\u003earray\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e description\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e value\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e balance\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e overdraft\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ePrecisei adicionar uma chave \u003ccode\u003ereverseSeq\u003c/code\u003e que é uma auto-decrement para os registros ficarem ordenados iniciando pelos\núltimos inseridos. Apesar do LMDB ser transacional, para gerar essa chave de forma única, criei um mutex compartilhado\n(\u003ccode\u003eboost::interprocess::named_mutex\u003c/code\u003e) entre os dois containers de API. Pra isso foi necessário colocá-los no mesmo\n\u003ccode\u003epid namespace\u003c/code\u003e do docker.\u003c/p\u003e\n\u003cp\u003eUsei 0,4 CPU e 150MB para cada um dos dois containers de API e 0,7 CPU e 150MB para o haproxy.\nA mongoose foi usada como no Firebird, com \u003ccode\u003eSO_REUSEPORT\u003c/code\u003e. O LMDB permite (e requer) que apenas uma conexão seja feita\npara cada banco de dados em um mesmo processo.\u003c/p\u003e\n\u003ch1\u003eUma técnica interessante\u003c/h1\u003e\n\u003cp\u003eCheguei a testar uma técnica interessante que mostrou ter um desempenho muito bom, mas com alguns picos que\natrapalhavam. Não debuguei o problema e não coloquei em nenhum dos projetos.\u003c/p\u003e\n\u003cp\u003eA técnica foi criar um load balancer próprio com a mongoose e repassar os sockets abertos para as APIs responderem\ndiretamente aos clientes, sem rotear as respostas usando o load balancer. Essa técnica é chamada socket takeover e\nfoi detalhada\n\u003ca href=\"https://copyconstruct.medium.com/file-descriptor-transfer-over-unix-domain-sockets-dcbbf5b3b6ec\"\u003eaqui\u003c/a\u003e,\nembora com motivação diferente.\u003c/p\u003e\n\u003ch1\u003eA ideia inicial\u003c/h1\u003e\n\u003cp\u003eInicialmente minha ideia era desenvolver a API usando GRPC e colocar o \u003ca href=\"https://www.envoyproxy.io/\"\u003eenvoy\u003c/a\u003e como\nload balancer fazendo a conversão de HTTP para GRPC. Isso até foi possível usando\n\u003ca href=\"https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/grpc_json_transcoder_filter\"\u003eesse filtro\u003c/a\u003e,\ncom algumas dificuldades de conversão de respostas GRPC para status code HTTP nos casos de erros, onde foi necessário\nusar scrips LUA. Porém o desempenho não foi bom.\u003c/p\u003e\n\u003ch1\u003eCuriosidades\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eA mongoose não suporta o uso de \u003ccode\u003eSO_REUSEPORT\u003c/code\u003e mas se tiver um \u003ccode\u003e#define\u003c/code\u003e com o nome \u003ccode\u003eSO_EXCLUSIVEADDRUSE\u003c/code\u003e ela\nseta essa flag nos sockets. Como esse define não existe no Linux, criei um \u003ccode\u003etriplet vcpkg\u003c/code\u003e e um \u003ccode\u003etoolchain cmake\u003c/code\u003e\npara passar \u003ccode\u003eSO_REUSEPORT\u003c/code\u003e no lugar:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-cmake\"\u003e\u003ccode class=\"language-cmake\"\u003e\u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003eCMAKE_C_FLAGS\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-DSO_EXCLUSIVEADDRUSE=SO_REUSEPORT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eUsei o \u003ccode\u003ehaproxy\u003c/code\u003e no modo \u003ccode\u003etcp\u003c/code\u003e para ter o mínimo overhead possível\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUsei o gerenciador de memória \u003ca href=\"https://github.com/microsoft/mimalloc\"\u003emimalloc\u003c/a\u003e da Microsoft para economizar\nalguns ciclos de CPU\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA função \u003ccode\u003emg_match\u003c/code\u003e da mongoose foi mais rápida do que deixar uma regex C++ pré-compilada\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003estd::format_to_n\u003c/code\u003e foi mais rápida que \u003ccode\u003esprintf\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eg++\u003c/code\u003e (com \u003ccode\u003elibstdc++\u003c/code\u003e) foi mais rapido que \u003ccode\u003eclang++\u003c/code\u003e com \u003ccode\u003elibstdc++\u003c/code\u003e e \u003ccode\u003elibc++\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUsando a experiência que adquiriram na rinha de 2023, usei \u003ccode\u003enetwork_mode: host\u003c/code\u003e em todos os containers, embora nas\nminhas máquinas não tenha tido vantagens\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","layout":"post","title":"Rinha de Backend - 2024/Q1","published":true,"date":"2024-03-10","author":"Adriano dos Santos Fernandes","tags":["c++","docker","firebird","postgresql","web"]}},"__N_SSG":true},"page":"/[...id]","query":{"id":["2024","03","10","rinha-backend-2024-q1"]},"buildId":"QpA8urRTnSyrpC8O9BUuL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>