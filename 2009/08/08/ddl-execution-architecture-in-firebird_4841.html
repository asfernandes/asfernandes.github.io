<!DOCTYPE html><html><head><link rel="alternate" type="application/rss+xml" title="RSS feed for blog posts" href="https://asfernandes.github.io/feed.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-7263221-3"></script><script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());

                    gtag('config', 'UA-7263221-3', {
                      page_path: window.location.pathname
                    });
                  </script><script type="text/javascript">
                    var sc_project=11098306;
                    var sc_invisible=1;
                    var sc_security='a73f5966';
                  </script><script async="" type="text/javascript" src="https://www.statcounter.com/counter/counter.js"></script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="asfernandes&#x27; blog"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous"/><title>DDL execution architecture in Firebird - why we need to move on</title><meta name="next-head-count" content="10"/><link rel="preload" href="/_next/static/css/ec84a65119aa10b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ec84a65119aa10b3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a61fb956a8c927dd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a61fb956a8c927dd.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-8c9020416d6299df.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3557c8f641e8fcfd.js" defer=""></script><script src="/_next/static/chunks/494-57da9477bc49be22.js" defer=""></script><script src="/_next/static/chunks/915-27b6902eaf029f1b.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...id%5D-896c0109065db4f8.js" defer=""></script><script src="/_next/static/F-UxrA5O4vTbAFKICkmSC/_buildManifest.js" defer=""></script><script src="/_next/static/F-UxrA5O4vTbAFKICkmSC/_ssgManifest.js" defer=""></script><script src="/_next/static/F-UxrA5O4vTbAFKICkmSC/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><header class="layout_header__kY0Lt"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">asfernandes&#x27; blog</a></div><div class="collapse navbar-collapse " id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a href="https://github.com/sponsors/asfernandes" target="_blank"><span class="fa fa-heart" style="color:red;margin-right:0.3em"></span>SPONSOR</a></li><li><a href="/contact">CONTACT</a></li><li><a href="/search" class="nav-search-link" title="Search"><span class="fa fa-search nav-search-icon"></span><span class="nav-search-text"></span></a></li></ul></div></div></nav></header><main><article><h1 class="utils_headingXl__u25Y2">DDL execution architecture in Firebird - why we need to move on</h1><div class="utils_lightText__eUzGY" style="margin-bottom:1em">Posted on <time dateTime="2009-08-08T19:17:00.001-03:00">August 8, 2009</time> in <a href="/tag/firebird">firebird</a></div><div><p>Here I'm going to explain how Firebird DDL commands works in the architecture, why it stops innovation and how it is supposed to work in Firebird 3.0.<br><br> DDL in FB works more or less like DML, so first a briefly explanation of how DML works. When a DML command is prepared, it starts in the parser constructing a tree of nodes. That nodes are all a single pointer type, used for all node types and others usages (like storing constants). A node have a list of child nodes.<br><br> After parsing, it enters in the semantics phase, where things are verified and adjusted with execution in mind. After that, it enters in the generation phase, that outputs BLR bytes and stores them in the statement. <br><br> The DSQL API is a layer around the engine API. The engine API knows only how to execute BLR. Hence the DSQL API does passes the stored BLR to that lower level functions (engine API).<br><br> For engine API, there is no knowledge of DSQL nodes and the processing done in the semantics phase. The engine does a parse of BLR, reconstruct another tree and compiles it. That does almost what DSQL does, but DSQL does it on SQL code and engine does it on BLR bytes.<br><br> When a statement is executed, the BLR tree is traversed and everything runs.<br><br> So back to DDL... DDL is not described as BLR, but in an equivalent binary format: DYN. Some DYN verbs have BLR bytes embedded, like the body of a stored procedure, but that is not relevant for generic DDL handling.<br><br> As in DML case, the engine knows nothing about DDL nodes constructed in DSQL. The engine knows only how to run DYN, with the isc_ddl API. In DSQL, everything works as in DML, but the generation phase emits DYN bytes, and statement execution is layered around isc_ddl.<br><br> So you might ask, what's wrong with DDL execution if it's so consistent with DML?<br><br> A lot of things, I'd say:<br> <br><ul><li> DYN codes are very badly structured. Some codes that would be private for some specific verbs shares the "number space" of all verbs. That make things visible wrong. </li></ul><ul><li>Related to above, we're going out of space. In v2.5, we're at number 247. We could go only at 254, and use the 255 to make a second number space. This would make things even worse. <br></li></ul><ul><li>While some may say that BLR is also bad, this is a model not invented in InterBase/Firebird. This is how compilers works (assembly, byte codes, etc). But that model does not have any practical benefit in DDL.</li></ul><ul><li>Too much code is used to convert DSQL structures to bytes and to engine again.</li></ul><div><ul><li>There is large code duplication to handle similar things, like CREATE / ALTER commands.</li></ul><ul><li>DYN execution is totally unnatural for a RDBMS system. A CREATE PROCEDURE command is more or less defined this way: <br></li></ul></div><div> <br><div style="margin-left: 40px;"> <span style="font-family: Courier New;">isc_dyn_def_procedure, &#x3C;name>,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_prc_source, &#x3C;source>,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> ...,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> // for each parameter - begin</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_def_parameter, &#x3C;name>,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_prm_number, &#x3C;number>,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_prm_type, &#x3C;type>,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> ...,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_end,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> // for each parameter - end</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_prc_blr, &#x3C;bytes>,</span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> isc_dyn_end</span><br style="font-family: Courier New;"></div> <br><div style="margin-left: 40px;"> And is executed in this way (pseudo-code):<br><br></div>  <div style="margin-left: 80px;"><span style="font-family: Courier New;">function DYN_execute() </span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    while ((dynVerb = getDynByte()) != isc_dyn_end) </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        switch (dynVerb) </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            case isc_dyn_def_procedure: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                DYN_define_procedure(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                break; </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            case isc_dyn_def_parameter: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                DYN_define_parameter(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                break; </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            ... </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        } </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    } </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">} </span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;"> function DYN_define_procedure() </span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    procName = getString(); </span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">    while ((dynVerb = getDynByte()) != isc_dyn_end) </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        switch (dynVerb) </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            case isc_dyn_prc_source: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                procSource = getString(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                break; </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            case isc_dyn_prc_blr: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                procBlr = getBytes(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                break; </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            ... </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            default: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                DYN_execute(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        } </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    } </span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">    INSERT INTO RDB$PROCEDURES </span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> } </span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;"> function DYN_define_parameter() </span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">         paramName = getString(); </span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">    while ((dynVerb = getDynByte()) != isc_dyn_end) </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        switch (dynVerb) </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        { </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            case isc_dyn_prm_number: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                paramNumber = getNumber(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                break; </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            case isc_dyn_prm_type: </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                paramType = getParamType(); </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">                break; </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">            ...</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">        } </span><br style="font-family: Courier New;"><span style="font-family: Courier New;">    } </span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">    INSERT INTO RDB$PROCEDURE_PARAMETERS </span><br style="font-family: Courier New;"><span style="font-family: Courier New;"> } </span><br style="font-family: Courier New;"></div>       <div style="margin-left: 40px;"><br> Did you see what is wrong? Did you ever asked why Firebird system tables does not have primary and foreign keys?<br><br> The answer is simple, there is no way to have a FK from RDB$PROCEDURE_PARAMETERS to RDB$PROCEDURES if the records in RDB$PROCEDURE_PARAMETERS are inserted first.<br></div> <br> With these problems defined, I started an alternate DDL path in v2.5, with the ALTER CHARACTER SET command. This command does not emit DYN, and when asked to execute, it does execute directly in DSQL with a new C++ friendly node (also used in the parser).<br><br> This was not sufficient through. To have benefits, existing commands shall also be migrated to the new scheme, and DYN should better be totally eliminated. The problem of this is that, documented or not, DYN and isc_ddl are part of the API, and used by client tools. The GDEF utility is totally based on it, as well DDL commands of GPRE.<br><br> These archaic utilities are the reason of how things had been defined in this way and why it never changed. Natively, former InterBase versions didn't understand text commands. DDL and DML had been part of client utilities, that compiles them and send BLR/DYN to the server.<br><br> Fortunately the Firebird team agreed to deprecate (in the sense of warn to tell to not use anymore) these things in v2.5, so it will be eliminated in v3.0.<br><br> <a href="http://firebird.cvs.sourceforge.net/viewvc/firebird/firebird2/?pathrev=B2_5_ExtEngines">In my branch for v3.0</a>, I started to implement this conversion. Procedures and triggers had been refactored and their DYN handling was eliminated. The new external function was also done in the new scheme. With nice C++ classes, the architecture of PACKAGES became smooth. Also, the implementation of these commands became shorter, self-contained and much more readable.<br><br> Yesterday, I did a step further and did some unification of EXECUTE BLOCK (DML) with procedures and triggers (DDL) code. A prototype of sub-procedures is in the way...<br></div><br></p>
</div></article><div class="utils_socialButtons__oMV54"><button aria-label="facebook" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="whatsapp" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#25D366"></circle><path d="m42.32286,33.93287c-0.5178,-0.2589 -3.04726,-1.49644 -3.52105,-1.66732c-0.4712,-0.17346 -0.81554,-0.2589 -1.15987,0.2589c-0.34175,0.51004 -1.33075,1.66474 -1.63108,2.00648c-0.30032,0.33658 -0.60064,0.36247 -1.11327,0.12945c-0.5178,-0.2589 -2.17994,-0.80259 -4.14759,-2.56312c-1.53269,-1.37217 -2.56312,-3.05503 -2.86603,-3.57283c-0.30033,-0.5178 -0.03366,-0.80259 0.22524,-1.06149c0.23301,-0.23301 0.5178,-0.59547 0.7767,-0.90616c0.25372,-0.31068 0.33657,-0.5178 0.51262,-0.85437c0.17088,-0.36246 0.08544,-0.64725 -0.04402,-0.90615c-0.12945,-0.2589 -1.15987,-2.79613 -1.58964,-3.80584c-0.41424,-1.00971 -0.84142,-0.88027 -1.15987,-0.88027c-0.29773,-0.02588 -0.64208,-0.02588 -0.98382,-0.02588c-0.34693,0 -0.90616,0.12945 -1.37736,0.62136c-0.4712,0.5178 -1.80194,1.76053 -1.80194,4.27186c0,2.51134 1.84596,4.945 2.10227,5.30747c0.2589,0.33657 3.63497,5.51458 8.80262,7.74113c1.23237,0.5178 2.1903,0.82848 2.94111,1.08738c1.23237,0.38836 2.35599,0.33657 3.24402,0.20712c0.99159,-0.15534 3.04985,-1.24272 3.47963,-2.45956c0.44013,-1.21683 0.44013,-2.22654 0.31068,-2.45955c-0.12945,-0.23301 -0.46601,-0.36247 -0.98382,-0.59548m-9.40068,12.84407l-0.02589,0c-3.05503,0 -6.08417,-0.82849 -8.72495,-2.38189l-0.62136,-0.37023l-6.47252,1.68286l1.73463,-6.29129l-0.41424,-0.64725c-1.70875,-2.71846 -2.6149,-5.85116 -2.6149,-9.07706c0,-9.39809 7.68934,-17.06155 17.15993,-17.06155c4.58253,0 8.88029,1.78642 12.11655,5.02268c3.23625,3.21036 5.02267,7.50812 5.02267,12.06476c-0.0078,9.3981 -7.69712,17.06155 -17.14699,17.06155m14.58906,-31.58846c-3.93529,-3.80584 -9.1133,-5.95471 -14.62789,-5.95471c-11.36055,0 -20.60848,9.2065 -20.61625,20.52564c0,3.61684 0.94757,7.14565 2.75211,10.26282l-2.92557,10.63564l10.93337,-2.85309c3.0136,1.63108 6.4052,2.4958 9.85634,2.49839l0.01037,0c11.36574,0 20.61884,-9.2091 20.62403,-20.53082c0,-5.48093 -2.14111,-10.64081 -6.03239,-14.51915" fill="white"></path></svg></button><button aria-label="linkedin" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button><button aria-label="email" class="react-share__ShareButton utils_socialButton__Dz42W" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#7f7f7f"></circle><path d="M17,22v20h30V22H17z M41.1,25L32,32.1L22.9,25H41.1z M20,39V26.6l12,9.3l12-9.3V39H20z" fill="white"></path></svg></button></div><div id="disqus_thread"></div></main><div class="layout_backToHome__9sjx_"><a href="/">← Back to home</a></div></div><footer class="layout_footer__dka_2"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/sponsors/asfernandes" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://twitter.com/adrianosf" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href="mailto:adrianosf@gmail.com" title="E-mail me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://linkedin.com/in/adrianosf" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://asfernandes.github.io/feed.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="layout_copyright__3e0Cv text-center text-muted">Copyright © Adriano dos Santos Fernandes</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2009","08","08","ddl-execution-architecture-in-firebird_4841"],"contentHtml":"\u003cp\u003eHere I'm going to explain how Firebird DDL commands works in the architecture, why it stops innovation and how it is supposed to work in Firebird 3.0.\u003cbr\u003e\u003cbr\u003e DDL in FB works more or less like DML, so first a briefly explanation of how DML works. When a DML command is prepared, it starts in the parser constructing a tree of nodes. That nodes are all a single pointer type, used for all node types and others usages (like storing constants). A node have a list of child nodes.\u003cbr\u003e\u003cbr\u003e After parsing, it enters in the semantics phase, where things are verified and adjusted with execution in mind. After that, it enters in the generation phase, that outputs BLR bytes and stores them in the statement. \u003cbr\u003e\u003cbr\u003e The DSQL API is a layer around the engine API. The engine API knows only how to execute BLR. Hence the DSQL API does passes the stored BLR to that lower level functions (engine API).\u003cbr\u003e\u003cbr\u003e For engine API, there is no knowledge of DSQL nodes and the processing done in the semantics phase. The engine does a parse of BLR, reconstruct another tree and compiles it. That does almost what DSQL does, but DSQL does it on SQL code and engine does it on BLR bytes.\u003cbr\u003e\u003cbr\u003e When a statement is executed, the BLR tree is traversed and everything runs.\u003cbr\u003e\u003cbr\u003e So back to DDL... DDL is not described as BLR, but in an equivalent binary format: DYN. Some DYN verbs have BLR bytes embedded, like the body of a stored procedure, but that is not relevant for generic DDL handling.\u003cbr\u003e\u003cbr\u003e As in DML case, the engine knows nothing about DDL nodes constructed in DSQL. The engine knows only how to run DYN, with the isc_ddl API. In DSQL, everything works as in DML, but the generation phase emits DYN bytes, and statement execution is layered around isc_ddl.\u003cbr\u003e\u003cbr\u003e So you might ask, what's wrong with DDL execution if it's so consistent with DML?\u003cbr\u003e\u003cbr\u003e A lot of things, I'd say:\u003cbr\u003e \u003cbr\u003e\u003cul\u003e\u003cli\u003e DYN codes are very badly structured. Some codes that would be private for some specific verbs shares the \"number space\" of all verbs. That make things visible wrong. \u003c/li\u003e\u003c/ul\u003e\u003cul\u003e\u003cli\u003eRelated to above, we're going out of space. In v2.5, we're at number 247. We could go only at 254, and use the 255 to make a second number space. This would make things even worse. \u003cbr\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul\u003e\u003cli\u003eWhile some may say that BLR is also bad, this is a model not invented in InterBase/Firebird. This is how compilers works (assembly, byte codes, etc). But that model does not have any practical benefit in DDL.\u003c/li\u003e\u003c/ul\u003e\u003cul\u003e\u003cli\u003eToo much code is used to convert DSQL structures to bytes and to engine again.\u003c/li\u003e\u003c/ul\u003e\u003cdiv\u003e\u003cul\u003e\u003cli\u003eThere is large code duplication to handle similar things, like CREATE / ALTER commands.\u003c/li\u003e\u003c/ul\u003e\u003cul\u003e\u003cli\u003eDYN execution is totally unnatural for a RDBMS system. A CREATE PROCEDURE command is more or less defined this way: \u003cbr\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/div\u003e\u003cdiv\u003e \u003cbr\u003e\u003cdiv style=\"margin-left: 40px;\"\u003e \u003cspan style=\"font-family: Courier New;\"\u003eisc_dyn_def_procedure, \u0026#x3C;name\u003e,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_prc_source, \u0026#x3C;source\u003e,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e ...,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e // for each parameter - begin\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_def_parameter, \u0026#x3C;name\u003e,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_prm_number, \u0026#x3C;number\u003e,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_prm_type, \u0026#x3C;type\u003e,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e ...,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_end,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e // for each parameter - end\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_prc_blr, \u0026#x3C;bytes\u003e,\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e isc_dyn_end\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003c/div\u003e \u003cbr\u003e\u003cdiv style=\"margin-left: 40px;\"\u003e And is executed in this way (pseudo-code):\u003cbr\u003e\u003cbr\u003e\u003c/div\u003e  \u003cdiv style=\"margin-left: 80px;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003efunction DYN_execute() \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    while ((dynVerb = getDynByte()) != isc_dyn_end) \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        switch (dynVerb) \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            case isc_dyn_def_procedure: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                DYN_define_procedure(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                break; \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            case isc_dyn_def_parameter: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                DYN_define_parameter(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                break; \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            ... \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e} \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e function DYN_define_procedure() \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    procName = getString(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    while ((dynVerb = getDynByte()) != isc_dyn_end) \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        switch (dynVerb) \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            case isc_dyn_prc_source: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                procSource = getString(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                break; \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            case isc_dyn_prc_blr: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                procBlr = getBytes(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                break; \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            ... \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            default: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                DYN_execute(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    INSERT INTO RDB$PROCEDURES \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e function DYN_define_parameter() \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e         paramName = getString(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    while ((dynVerb = getDynByte()) != isc_dyn_end) \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        switch (dynVerb) \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        { \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            case isc_dyn_prm_number: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                paramNumber = getNumber(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                break; \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            case isc_dyn_prm_type: \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                paramType = getParamType(); \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e                break; \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e            ...\u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e        } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e    INSERT INTO RDB$PROCEDURE_PARAMETERS \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003cspan style=\"font-family: Courier New;\"\u003e } \u003c/span\u003e\u003cbr style=\"font-family: Courier New;\"\u003e\u003c/div\u003e       \u003cdiv style=\"margin-left: 40px;\"\u003e\u003cbr\u003e Did you see what is wrong? Did you ever asked why Firebird system tables does not have primary and foreign keys?\u003cbr\u003e\u003cbr\u003e The answer is simple, there is no way to have a FK from RDB$PROCEDURE_PARAMETERS to RDB$PROCEDURES if the records in RDB$PROCEDURE_PARAMETERS are inserted first.\u003cbr\u003e\u003c/div\u003e \u003cbr\u003e With these problems defined, I started an alternate DDL path in v2.5, with the ALTER CHARACTER SET command. This command does not emit DYN, and when asked to execute, it does execute directly in DSQL with a new C++ friendly node (also used in the parser).\u003cbr\u003e\u003cbr\u003e This was not sufficient through. To have benefits, existing commands shall also be migrated to the new scheme, and DYN should better be totally eliminated. The problem of this is that, documented or not, DYN and isc_ddl are part of the API, and used by client tools. The GDEF utility is totally based on it, as well DDL commands of GPRE.\u003cbr\u003e\u003cbr\u003e These archaic utilities are the reason of how things had been defined in this way and why it never changed. Natively, former InterBase versions didn't understand text commands. DDL and DML had been part of client utilities, that compiles them and send BLR/DYN to the server.\u003cbr\u003e\u003cbr\u003e Fortunately the Firebird team agreed to deprecate (in the sense of warn to tell to not use anymore) these things in v2.5, so it will be eliminated in v3.0.\u003cbr\u003e\u003cbr\u003e \u003ca href=\"http://firebird.cvs.sourceforge.net/viewvc/firebird/firebird2/?pathrev=B2_5_ExtEngines\"\u003eIn my branch for v3.0\u003c/a\u003e, I started to implement this conversion. Procedures and triggers had been refactored and their DYN handling was eliminated. The new external function was also done in the new scheme. With nice C++ classes, the architecture of PACKAGES became smooth. Also, the implementation of these commands became shorter, self-contained and much more readable.\u003cbr\u003e\u003cbr\u003e Yesterday, I did a step further and did some unification of EXECUTE BLOCK (DML) with procedures and triggers (DDL) code. A prototype of sub-procedures is in the way...\u003cbr\u003e\u003c/div\u003e\u003cbr\u003e\u003c/p\u003e\n","layout":"post","title":"DDL execution architecture in Firebird - why we need to move on","date":"2009-08-08T19:17:00.001-03:00","author":"Adriano dos Santos Fernandes","tags":["firebird"],"modified_time":"2009-08-09T12:10:35.267-03:00","blogger_id":"tag:blogger.com,1999:blog-3443854162607009076.post-343028017659761590","blogger_orig_url":"http://asfernandes.blogspot.com/2009/08/ddl-execution-architecture-in-firebird_4841.html"}},"__N_SSG":true},"page":"/[...id]","query":{"id":["2009","08","08","ddl-execution-architecture-in-firebird_4841"]},"buildId":"F-UxrA5O4vTbAFKICkmSC","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>