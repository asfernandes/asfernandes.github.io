<!DOCTYPE html><html><head><link rel="alternate" type="application/rss+xml" title="RSS feed for blog posts" href="https://asfernandes.github.io/feed.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-7263221-3"></script><script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());

                    gtag('config', 'UA-7263221-3', {
                      page_path: window.location.pathname
                    });
                  </script><script type="text/javascript">
                    var sc_project=11098306;
                    var sc_invisible=1;
                    var sc_security='a73f5966';
                  </script><script async="" type="text/javascript" src="https://www.statcounter.com/counter/counter.js"></script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="asfernandes&#x27; blog"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous"/><title>Influence of network latency in the Firebird wire protocol</title><meta name="next-head-count" content="10"/><link rel="preload" href="/_next/static/css/6ef816ec1ff1863a44b8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6ef816ec1ff1863a44b8.css" data-n-g=""/><link rel="preload" href="/_next/static/css/700bac53100c8f675a6b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/700bac53100c8f675a6b.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-7b93a5f561ae081d75f3.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework-8866fe8c01e4d65da4f2.js" as="script"/><link rel="preload" href="/_next/static/chunks/597-22fbf75857fb562c43e5.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-e746c11fc92907085dc6.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-90e40cde781992767b75.js" as="script"/><link rel="preload" href="/_next/static/chunks/794-0bc3b9b310bfaef5f98c.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/%5B...id%5D-7a554f06ecf14fc2fe64.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">asfernandes&#x27; blog</a></div><div class="collapse navbar-collapse " id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a href="/contact">CONTACT</a></li><li><a href="/search" class="nav-search-link" title="Search"><span class="fa fa-search nav-search-icon"></span><span class="nav-search-text"></span></a></li></ul></div></div></nav></header><main><article><h1 class="utils_headingXl__1XecN">Influence of network latency in the Firebird wire protocol</h1><div class="utils_lightText__12Ckm" style="margin-bottom:1em">Posted on <time dateTime="2009-07-12T23:25:00.001-03:00">July 13, 2009</time> in <a href="/tag/firebird">firebird</a></div><div><p>People often talk that Firebird performs badly in networks with high latency. I did some tests to see how the new protocol has been improved compared to the old one, and to see how it could be improved even more. My tests only cares about <strong>latency</strong>, and not about bandwidth.</p>
<p>It simulate network latency in Linux using <a href="http://www.linuxfoundation.org/en/Net:Netem">Netem</a>. With the <code>tc</code> utility, we can add a delay for outbound traffic. Since I did it for <em>lo</em> interface, it happens that it works for in/out traffic. I set delay to 100ms (that is more or less a value I found doing it in the internet with my horrible Telefonica <del>speed</del>y connection), using this command:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> tc qdisc <span class="token function">add</span> dev lo root handle <span class="token number">1</span>:0 netem delay 100ms
</code></pre></div>
<p>And here is the result of a <code>ping</code>:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">ping</span> localhost
PING localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">200</span> ms
<span class="token number">64</span> bytes from localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">200</span> ms
<span class="token number">64</span> bytes from localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">200</span> ms
<span class="token number">64</span> bytes from localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">200</span> ms
</code></pre></div>
<p>To later remove the delay, the command is:</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> tc qdisc del dev lo root
</code></pre></div>
<p>The test uses <a href="http://code.google.com/p/cppsys/source/browse/#svn/trunk/src/CppSys/Database/Firebird">Firebird library</a> present on (my till unknown) <a href="http://code.google.com/p/cppsys">CppSys</a> project (more on CppSys in a future post). The CppSys database library has interfaces and semantics based on JDBC. The relevant test code is here:</p>
<div class="remark-highlight"><pre class="language-cpp"><code class="language-cpp"><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Connecting to the database"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AutoPtr<span class="token operator">&#x3C;</span>FbDatabase<span class="token operator">></span> <span class="token function">database</span><span class="token punctuation">(</span>client<span class="token operator">-></span><span class="token function">openDatabase</span><span class="token punctuation">(</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"firebird:"</span><span class="token punctuation">)</span> <span class="token operator">+</span> databaseName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Starting the transaction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AutoPtr<span class="token operator">&#x3C;</span>FbTransaction<span class="token operator">></span> <span class="token function">transaction</span><span class="token punctuation">(</span>database<span class="token operator">-></span><span class="token function">startTransaction</span><span class="token punctuation">(</span>
    TransactionIsolation<span class="token operator">::</span>SNAPSHOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Preparing stmt1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AutoPtr<span class="token operator">&#x3C;</span>FbPreparedStatement<span class="token operator">></span> <span class="token function">stmt1</span><span class="token punctuation">(</span>database<span class="token operator">-></span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
    transaction<span class="token punctuation">,</span>
    <span class="token string">"select rdb$relation_name from rdb$relations"</span>
    <span class="token string">"    where rdb$system_flag = 1"</span>
    <span class="token string">"    order by rdb$relation_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Preparing stmt2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AutoPtr<span class="token operator">&#x3C;</span>FbPreparedStatement<span class="token operator">></span> <span class="token function">stmt2</span><span class="token punctuation">(</span>database<span class="token operator">-></span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
    transaction<span class="token punctuation">,</span>
    <span class="token string">"select rdb$field_name from rdb$relation_fields"</span>
    <span class="token string">"    where rdb$relation_name = ?"</span>
    <span class="token string">"    order by rdb$field_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Preparing stmt3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AutoPtr<span class="token operator">&#x3C;</span>FbPreparedStatement<span class="token operator">></span> <span class="token function">stmt3</span><span class="token punctuation">(</span>database<span class="token operator">-></span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
    transaction<span class="token punctuation">,</span>
    <span class="token string">"select rdb$trigger_name from rdb$triggers"</span>
    <span class="token string">"    where rdb$relation_name = ?"</span>
    <span class="token string">"    order by rdb$trigger_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Executing stmt1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AutoPtr<span class="token operator">&#x3C;</span>FbResultSet<span class="token operator">></span> <span class="token function">rs1</span><span class="token punctuation">(</span>stmt1<span class="token operator">-></span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Starting fetch rs1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>rs1<span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rs1: %s"</span><span class="token punctuation">,</span> rs1<span class="token operator">-></span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\tExecuting stmt2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stmt2<span class="token operator">-></span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> rs1<span class="token operator">-></span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AutoPtr<span class="token operator">&#x3C;</span>FbResultSet<span class="token operator">></span> <span class="token function">rs2</span><span class="token punctuation">(</span>stmt2<span class="token operator">-></span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\tExecuting stmt3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stmt3<span class="token operator">-></span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> rs1<span class="token operator">-></span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AutoPtr<span class="token operator">&#x3C;</span>FbResultSet<span class="token operator">></span> <span class="token function">rs3</span><span class="token punctuation">(</span>stmt3<span class="token operator">-></span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\tStarting fetch rs2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>rs2<span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\trs2: %s"</span><span class="token punctuation">,</span> rs2<span class="token operator">-></span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\tStarting fetch rs3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>rs3<span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\trs3: %s"</span><span class="token punctuation">,</span> rs3<span class="token operator">-></span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The <em>println</em> function buffers the text and prints it in its next run, with the current time (in minus) milliseconds the time when the text was buffered. Here is its code:</p>
<div class="remark-highlight"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> lineBuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> int64 lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    timeb tb<span class="token punctuation">;</span>
    <span class="token function">ftime</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>tb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    int64 thisTime <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> tb<span class="token punctuation">.</span>millitm<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTime <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        lastTime <span class="token operator">=</span> thisTime<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%06d: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>thisTime <span class="token operator">-</span> lastTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
            lineBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    va_list va<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>va<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">vsprintf</span><span class="token punctuation">(</span>lineBuffer<span class="token punctuation">,</span> format<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">va_end</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>

    lastTime <span class="token operator">=</span> thisTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>As you see, the test does what every client/server database developer must knows that he/she shouldn't do: a main query with nested queries for each record. If you ever run <code>isql</code> over the internet, you had see it performs very slow, and that is the reason. <code>isql</code> does just that. It does that because it's written using embedded SQL with <code>gpre</code> and sometimes this is needed to access new columns that may not be presented on a database of an older ODS. And due to embedded SQL nature, "details" of where and when to prepare statements are just ignored.</p>
<p>So far, here is the results.</p>
<p>Result for the <strong>old protocol</strong>, with 2.0 client and 2.5 server:</p>
<div class="remark-highlight"><pre class="language-txt"><code class="language-txt">000665: Connecting to the database
000201: Starting the transaction
001234: Preparing stmt1
001204: Preparing stmt2
001204: Preparing stmt3
000200: Executing stmt1
000202: Starting fetch rs1
000000: rs1: MON$ATTACHMENTS
000200:     Executing stmt2
000201:     Executing stmt3
000201:     Starting fetch rs2
000000:     rs2: MON$ATTACHMENT_ID
000000:     rs2: MON$ATTACHMENT_NAME
000000:     rs2: MON$CHARACTER_SET_ID
000001:     rs2: MON$GARBAGE_COLLECTION
000000:     rs2: MON$REMOTE_ADDRESS
000000:     rs2: MON$REMOTE_PID
000000:     rs2: MON$REMOTE_PROCESS
000001:     rs2: MON$REMOTE_PROTOCOL
000000:     rs2: MON$ROLE
000000:     rs2: MON$SERVER_PID
000000:     rs2: MON$STATE
000001:     rs2: MON$STAT_ID
000000:     rs2: MON$TIMESTAMP
000000:     rs2: MON$USER
000601:     Starting fetch rs3
000000: rs1: MON$CALL_STACK
000200:     Executing stmt2
000201:     Executing stmt3
000201:     Starting fetch rs2
000000:     rs2: MON$CALLER_ID
000000:     rs2: MON$CALL_ID
000000:     rs2: MON$OBJECT_NAME
000000:     rs2: MON$OBJECT_TYPE
000000:     rs2: MON$SOURCE_COLUMN
000000:     rs2: MON$SOURCE_LINE
000000:     rs2: MON$STATEMENT_ID
000001:     rs2: MON$STAT_ID
000000:     rs2: MON$TIMESTAMP
000601:     Starting fetch rs3
&#x26;lt;...&#x26;gt;
000000: rs1: RDB$CHECK_CONSTRAINTS
000200:     Executing stmt2
000200:     Executing stmt3
000200:     Starting fetch rs2
000001:     rs2: RDB$CONSTRAINT_NAME
000000:     rs2: RDB$TRIGGER_NAME
000200:     Starting fetch rs3
000000:     rs3: RDB$TRIGGER_14
000000:     rs3: RDB$TRIGGER_15
000001:     rs3: RDB$TRIGGER_16
000400:     rs3: RDB$TRIGGER_35
000000: rs1: RDB$COLLATIONS
&#x26;lt;...&#x26;gt;</code></pre></div>
<p>Result for the <strong>new protocol</strong>, with 2.5 client and 2.5 server:</p>
<div class="remark-highlight"><pre class="language-txt"><code class="language-txt">000670: Connecting to the database
000200: Starting the transaction
000229: Preparing stmt1
000203: Preparing stmt2
000203: Preparing stmt3
000000: Executing stmt1
000202: Starting fetch rs1
000000: rs1: MON$ATTACHMENTS
000000:     Executing stmt2
000000:     Executing stmt3
000202:     Starting fetch rs2
000000:     rs2: MON$ATTACHMENT_ID
000000:     rs2: MON$ATTACHMENT_NAME
000000:     rs2: MON$CHARACTER_SET_ID
000000:     rs2: MON$GARBAGE_COLLECTION
000000:     rs2: MON$REMOTE_ADDRESS
000000:     rs2: MON$REMOTE_PID
000000:     rs2: MON$REMOTE_PROCESS
000000:     rs2: MON$REMOTE_PROTOCOL
000000:     rs2: MON$ROLE
000000:     rs2: MON$SERVER_PID
000000:     rs2: MON$STATE
000000:     rs2: MON$STAT_ID
000000:     rs2: MON$TIMESTAMP
000000:     rs2: MON$USER
000200:     Starting fetch rs3
000000: rs1: MON$CALL_STACK
000001:     Executing stmt2
000000:     Executing stmt3
000200:     Starting fetch rs2
000000:     rs2: MON$CALLER_ID
000000:     rs2: MON$CALL_ID
000000:     rs2: MON$OBJECT_NAME
000001:     rs2: MON$OBJECT_TYPE
000000:     rs2: MON$SOURCE_COLUMN
000000:     rs2: MON$SOURCE_LINE
000000:     rs2: MON$STATEMENT_ID
000000:     rs2: MON$STAT_ID
000000:     rs2: MON$TIMESTAMP
000200:     Starting fetch rs3
&#x26;lt;...&#x26;gt;
000000: rs1: RDB$CHECK_CONSTRAINTS
000000:     Executing stmt2
000000:     Executing stmt3
000201:     Starting fetch rs2
000000:     rs2: RDB$CONSTRAINT_NAME
000000:     rs2: RDB$TRIGGER_NAME
000200:     Starting fetch rs3
000000:     rs3: RDB$TRIGGER_14
000000:     rs3: RDB$TRIGGER_15
000000:     rs3: RDB$TRIGGER_16
000000:     rs3: RDB$TRIGGER_35
000000: rs1: RDB$COLLATIONS
&#x26;lt;...&#x26;gt;</code></pre></div>
<p>FWIW, I did tested the old protocol on real network with similar latency too. The result was very resemblant.</p>
<p>The total times are:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Old protocol</td>
<td>55.5s</td>
</tr>
<tr>
<td>New Protocol</td>
<td>18.5s</td>
</tr>
<tr>
<td>New Protocol minus round-trip times of rs3</td>
<td>10.1s</td>
</tr>
</tbody>
</table>
<p>So we may see that:</p>
<ol>
<li>The old protocol is a crap.</li>
<li>The new protocol does a good job removing some "unnecessary" round-trips.</li>
<li>It may be improved.</li>
</ol>
<p>The first interesting problem is the series of statement preparations. The preparation of a statement may result in an error, so it necessary involves a round-trip so we can get the status from the server. But does it <strong>really needs</strong> it? Using Oracle JDBC driver, a prepareStatement with a wrong statement does not throw an exception. It's deferred. In fact, this is a contract, and a change in a contract would require some way for the client applications to enable or disable it.</p>
<p>The second interesting thing is that executing a statement that needs fetch does not involves a round-trip. Does it happens too when selecting from a SP? Won't this be a contract change as well, since selectable SPs could write to the database? I didn't did further tests... Anyway, that's what allows the optimizations I talk below.</p>
<p>Then we start the fetches. The first fetch for rs1 necessarily involves a round-trip and buffers some records in the client. Subsequents fetches are resolved locally.</p>
<p>The third interesting thing is about the nested queries. Since queries are executed, a round-trip would be inevitable, but it does one for each query. A more intelligent approach would be to fetch rs3 too when asked to fetch rs2, since it's already executed. In this test, it would run ~8s faster. And a much more intelligent approach would do it in the background (and transmitting asynchronous), without putting some overhead on the rs2 call.</p>
<p>With a super intelligent server/client/protocol, the client and the server may cache prepared statements, and the server may asynchronous send statements invalidations to the client. Then, preparation of statements would have no round-trip (when already prepared one time), being sure that the statement is not wrong.</p>
<p>So what you may do now?</p>
<ol>
<li>Do not talk with the server in this poor (and common) way. Use selectable SPs to run multiple queries.</li>
<li>Do not prepare/close/prepare your common statements. Cache them in your application.</li>
</ol>
</div></article><div class="utils_socialButtons__-DAAa"><button aria-label="facebook" class="react-share__ShareButton utils_socialButton__2IZ2i" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton utils_socialButton__2IZ2i" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="whatsapp" class="react-share__ShareButton utils_socialButton__2IZ2i" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#25D366"></circle><path d="m42.32286,33.93287c-0.5178,-0.2589 -3.04726,-1.49644 -3.52105,-1.66732c-0.4712,-0.17346 -0.81554,-0.2589 -1.15987,0.2589c-0.34175,0.51004 -1.33075,1.66474 -1.63108,2.00648c-0.30032,0.33658 -0.60064,0.36247 -1.11327,0.12945c-0.5178,-0.2589 -2.17994,-0.80259 -4.14759,-2.56312c-1.53269,-1.37217 -2.56312,-3.05503 -2.86603,-3.57283c-0.30033,-0.5178 -0.03366,-0.80259 0.22524,-1.06149c0.23301,-0.23301 0.5178,-0.59547 0.7767,-0.90616c0.25372,-0.31068 0.33657,-0.5178 0.51262,-0.85437c0.17088,-0.36246 0.08544,-0.64725 -0.04402,-0.90615c-0.12945,-0.2589 -1.15987,-2.79613 -1.58964,-3.80584c-0.41424,-1.00971 -0.84142,-0.88027 -1.15987,-0.88027c-0.29773,-0.02588 -0.64208,-0.02588 -0.98382,-0.02588c-0.34693,0 -0.90616,0.12945 -1.37736,0.62136c-0.4712,0.5178 -1.80194,1.76053 -1.80194,4.27186c0,2.51134 1.84596,4.945 2.10227,5.30747c0.2589,0.33657 3.63497,5.51458 8.80262,7.74113c1.23237,0.5178 2.1903,0.82848 2.94111,1.08738c1.23237,0.38836 2.35599,0.33657 3.24402,0.20712c0.99159,-0.15534 3.04985,-1.24272 3.47963,-2.45956c0.44013,-1.21683 0.44013,-2.22654 0.31068,-2.45955c-0.12945,-0.23301 -0.46601,-0.36247 -0.98382,-0.59548m-9.40068,12.84407l-0.02589,0c-3.05503,0 -6.08417,-0.82849 -8.72495,-2.38189l-0.62136,-0.37023l-6.47252,1.68286l1.73463,-6.29129l-0.41424,-0.64725c-1.70875,-2.71846 -2.6149,-5.85116 -2.6149,-9.07706c0,-9.39809 7.68934,-17.06155 17.15993,-17.06155c4.58253,0 8.88029,1.78642 12.11655,5.02268c3.23625,3.21036 5.02267,7.50812 5.02267,12.06476c-0.0078,9.3981 -7.69712,17.06155 -17.14699,17.06155m14.58906,-31.58846c-3.93529,-3.80584 -9.1133,-5.95471 -14.62789,-5.95471c-11.36055,0 -20.60848,9.2065 -20.61625,20.52564c0,3.61684 0.94757,7.14565 2.75211,10.26282l-2.92557,10.63564l10.93337,-2.85309c3.0136,1.63108 6.4052,2.4958 9.85634,2.49839l0.01037,0c11.36574,0 20.61884,-9.2091 20.62403,-20.53082c0,-5.48093 -2.14111,-10.64081 -6.03239,-14.51915" fill="white"></path></svg></button><button aria-label="linkedin" class="react-share__ShareButton utils_socialButton__2IZ2i" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton utils_socialButton__2IZ2i" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button><button aria-label="email" class="react-share__ShareButton utils_socialButton__2IZ2i" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#7f7f7f"></circle><path d="M17,22v20h30V22H17z M41.1,25L32,32.1L22.9,25H41.1z M20,39V26.6l12,9.3l12-9.3V39H20z" fill="white"></path></svg></button></div><div shortname="asfernandes-blog" config="[object Object]" id="disqus_thread"></div></main><div class="layout_backToHome__1vZsp"><a href="/">← Back to home</a></div></div><footer class="layout_footer__127N0"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/asfernandes" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://twitter.com/adrianosf" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href="mailto:adrianosf@gmail.com" title="E-mail me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://linkedin.com/in/adrianosf" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://asfernandes.github.io/feed.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="layout_copyright__xP9yl text-center text-muted">Copyright © Adriano dos Santos Fernandes</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":["2009","07","12","network-latency-influence-on-firebird"],"contentHtml":"\u003cp\u003ePeople often talk that Firebird performs badly in networks with high latency. I did some tests to see how the new protocol has been improved compared to the old one, and to see how it could be improved even more. My tests only cares about \u003cstrong\u003elatency\u003c/strong\u003e, and not about bandwidth.\u003c/p\u003e\n\u003cp\u003eIt simulate network latency in Linux using \u003ca href=\"http://www.linuxfoundation.org/en/Net:Netem\"\u003eNetem\u003c/a\u003e. With the \u003ccode\u003etc\u003c/code\u003e utility, we can add a delay for outbound traffic. Since I did it for \u003cem\u003elo\u003c/em\u003e interface, it happens that it works for in/out traffic. I set delay to 100ms (that is more or less a value I found doing it in the internet with my horrible Telefonica \u003cdel\u003espeed\u003c/del\u003ey connection), using this command:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e tc qdisc \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e dev lo root handle \u003cspan class=\"token number\"\u003e1\u003c/span\u003e:0 netem delay 100ms\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd here is the result of a \u003ccode\u003eping\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003eping\u003c/span\u003e localhost\nPING localhost \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e127.0\u003c/span\u003e.0.1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token number\"\u003e56\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e84\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e bytes of data.\n\u003cspan class=\"token number\"\u003e64\u003c/span\u003e bytes from localhost \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e127.0\u003c/span\u003e.0.1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e: \u003cspan class=\"token assign-left variable\"\u003eicmp_seq\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003ettl\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e64\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003etime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e ms\n\u003cspan class=\"token number\"\u003e64\u003c/span\u003e bytes from localhost \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e127.0\u003c/span\u003e.0.1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e: \u003cspan class=\"token assign-left variable\"\u003eicmp_seq\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003ettl\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e64\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003etime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e ms\n\u003cspan class=\"token number\"\u003e64\u003c/span\u003e bytes from localhost \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e127.0\u003c/span\u003e.0.1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e: \u003cspan class=\"token assign-left variable\"\u003eicmp_seq\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003ettl\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e64\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003etime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e ms\n\u003cspan class=\"token number\"\u003e64\u003c/span\u003e bytes from localhost \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e127.0\u003c/span\u003e.0.1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e: \u003cspan class=\"token assign-left variable\"\u003eicmp_seq\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003ettl\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e64\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003etime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e ms\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo later remove the delay, the command is:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e tc qdisc del dev lo root\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe test uses \u003ca href=\"http://code.google.com/p/cppsys/source/browse/#svn/trunk/src/CppSys/Database/Firebird\"\u003eFirebird library\u003c/a\u003e present on (my till unknown) \u003ca href=\"http://code.google.com/p/cppsys\"\u003eCppSys\u003c/a\u003e project (more on CppSys in a future post). The CppSys database library has interfaces and semantics based on JDBC. The relevant test code is here:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-cpp\"\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Connecting to the database\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nAutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbDatabase\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003edatabase\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eclient\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eopenDatabase\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"firebird:\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e databaseName\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Starting the transaction\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nAutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbTransaction\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003etransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edatabase\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003estartTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    TransactionIsolation\u003cspan class=\"token operator\"\u003e::\u003c/span\u003eSNAPSHOT\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Preparing stmt1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nAutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbPreparedStatement\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003estmt1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edatabase\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eprepareStatement\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"select rdb$relation_name from rdb$relations\"\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"    where rdb$system_flag = 1\"\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"    order by rdb$relation_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Preparing stmt2\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nAutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbPreparedStatement\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003estmt2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edatabase\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eprepareStatement\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"select rdb$field_name from rdb$relation_fields\"\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"    where rdb$relation_name = ?\"\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"    order by rdb$field_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Preparing stmt3\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nAutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbPreparedStatement\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003estmt3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edatabase\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eprepareStatement\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"select rdb$trigger_name from rdb$triggers\"\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"    where rdb$relation_name = ?\"\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"    order by rdb$trigger_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Executing stmt1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nAutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbResultSet\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003ers1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estmt1\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecuteQuery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Starting fetch rs1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ers1\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"rs1: %s\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rs1\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPtr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\\tExecuting stmt2\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    stmt2\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003esetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rs1\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    AutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbResultSet\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003ers2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estmt2\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecuteQuery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\\tExecuting stmt3\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    stmt3\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003esetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rs1\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    AutoPtr\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eFbResultSet\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003ers3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estmt3\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecuteQuery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\\tStarting fetch rs2\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ers2\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\\trs2: %s\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rs2\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPtr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\\tStarting fetch rs3\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ers3\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\\trs3: %s\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rs3\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPtr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003cem\u003eprintln\u003c/em\u003e function buffers the text and prints it in its next run, with the current time (in minus) milliseconds the time when the text was buffered. Here is its code:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-cpp\"\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e format\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e lineBuffer\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1024\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e int64 lastTime \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    timeb tb\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eftime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003etb\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    int64 thisTime \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eint64\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e tb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emillitm\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elastTime \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        lastTime \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e thisTime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"%06d: %s\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ethisTime \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e lastTime\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            lineBuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    va_list va\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eva_start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eva\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e format\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token function\"\u003evsprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elineBuffer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e format\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e va\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token function\"\u003eva_end\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eva\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    lastTime \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e thisTime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you see, the test does what every client/server database developer must knows that he/she shouldn't do: a main query with nested queries for each record. If you ever run \u003ccode\u003eisql\u003c/code\u003e over the internet, you had see it performs very slow, and that is the reason. \u003ccode\u003eisql\u003c/code\u003e does just that. It does that because it's written using embedded SQL with \u003ccode\u003egpre\u003c/code\u003e and sometimes this is needed to access new columns that may not be presented on a database of an older ODS. And due to embedded SQL nature, \"details\" of where and when to prepare statements are just ignored.\u003c/p\u003e\n\u003cp\u003eSo far, here is the results.\u003c/p\u003e\n\u003cp\u003eResult for the \u003cstrong\u003eold protocol\u003c/strong\u003e, with 2.0 client and 2.5 server:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-txt\"\u003e\u003ccode class=\"language-txt\"\u003e000665: Connecting to the database\n000201: Starting the transaction\n001234: Preparing stmt1\n001204: Preparing stmt2\n001204: Preparing stmt3\n000200: Executing stmt1\n000202: Starting fetch rs1\n000000: rs1: MON$ATTACHMENTS\n000200:     Executing stmt2\n000201:     Executing stmt3\n000201:     Starting fetch rs2\n000000:     rs2: MON$ATTACHMENT_ID\n000000:     rs2: MON$ATTACHMENT_NAME\n000000:     rs2: MON$CHARACTER_SET_ID\n000001:     rs2: MON$GARBAGE_COLLECTION\n000000:     rs2: MON$REMOTE_ADDRESS\n000000:     rs2: MON$REMOTE_PID\n000000:     rs2: MON$REMOTE_PROCESS\n000001:     rs2: MON$REMOTE_PROTOCOL\n000000:     rs2: MON$ROLE\n000000:     rs2: MON$SERVER_PID\n000000:     rs2: MON$STATE\n000001:     rs2: MON$STAT_ID\n000000:     rs2: MON$TIMESTAMP\n000000:     rs2: MON$USER\n000601:     Starting fetch rs3\n000000: rs1: MON$CALL_STACK\n000200:     Executing stmt2\n000201:     Executing stmt3\n000201:     Starting fetch rs2\n000000:     rs2: MON$CALLER_ID\n000000:     rs2: MON$CALL_ID\n000000:     rs2: MON$OBJECT_NAME\n000000:     rs2: MON$OBJECT_TYPE\n000000:     rs2: MON$SOURCE_COLUMN\n000000:     rs2: MON$SOURCE_LINE\n000000:     rs2: MON$STATEMENT_ID\n000001:     rs2: MON$STAT_ID\n000000:     rs2: MON$TIMESTAMP\n000601:     Starting fetch rs3\n\u0026#x26;lt;...\u0026#x26;gt;\n000000: rs1: RDB$CHECK_CONSTRAINTS\n000200:     Executing stmt2\n000200:     Executing stmt3\n000200:     Starting fetch rs2\n000001:     rs2: RDB$CONSTRAINT_NAME\n000000:     rs2: RDB$TRIGGER_NAME\n000200:     Starting fetch rs3\n000000:     rs3: RDB$TRIGGER_14\n000000:     rs3: RDB$TRIGGER_15\n000001:     rs3: RDB$TRIGGER_16\n000400:     rs3: RDB$TRIGGER_35\n000000: rs1: RDB$COLLATIONS\n\u0026#x26;lt;...\u0026#x26;gt;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eResult for the \u003cstrong\u003enew protocol\u003c/strong\u003e, with 2.5 client and 2.5 server:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-txt\"\u003e\u003ccode class=\"language-txt\"\u003e000670: Connecting to the database\n000200: Starting the transaction\n000229: Preparing stmt1\n000203: Preparing stmt2\n000203: Preparing stmt3\n000000: Executing stmt1\n000202: Starting fetch rs1\n000000: rs1: MON$ATTACHMENTS\n000000:     Executing stmt2\n000000:     Executing stmt3\n000202:     Starting fetch rs2\n000000:     rs2: MON$ATTACHMENT_ID\n000000:     rs2: MON$ATTACHMENT_NAME\n000000:     rs2: MON$CHARACTER_SET_ID\n000000:     rs2: MON$GARBAGE_COLLECTION\n000000:     rs2: MON$REMOTE_ADDRESS\n000000:     rs2: MON$REMOTE_PID\n000000:     rs2: MON$REMOTE_PROCESS\n000000:     rs2: MON$REMOTE_PROTOCOL\n000000:     rs2: MON$ROLE\n000000:     rs2: MON$SERVER_PID\n000000:     rs2: MON$STATE\n000000:     rs2: MON$STAT_ID\n000000:     rs2: MON$TIMESTAMP\n000000:     rs2: MON$USER\n000200:     Starting fetch rs3\n000000: rs1: MON$CALL_STACK\n000001:     Executing stmt2\n000000:     Executing stmt3\n000200:     Starting fetch rs2\n000000:     rs2: MON$CALLER_ID\n000000:     rs2: MON$CALL_ID\n000000:     rs2: MON$OBJECT_NAME\n000001:     rs2: MON$OBJECT_TYPE\n000000:     rs2: MON$SOURCE_COLUMN\n000000:     rs2: MON$SOURCE_LINE\n000000:     rs2: MON$STATEMENT_ID\n000000:     rs2: MON$STAT_ID\n000000:     rs2: MON$TIMESTAMP\n000200:     Starting fetch rs3\n\u0026#x26;lt;...\u0026#x26;gt;\n000000: rs1: RDB$CHECK_CONSTRAINTS\n000000:     Executing stmt2\n000000:     Executing stmt3\n000201:     Starting fetch rs2\n000000:     rs2: RDB$CONSTRAINT_NAME\n000000:     rs2: RDB$TRIGGER_NAME\n000200:     Starting fetch rs3\n000000:     rs3: RDB$TRIGGER_14\n000000:     rs3: RDB$TRIGGER_15\n000000:     rs3: RDB$TRIGGER_16\n000000:     rs3: RDB$TRIGGER_35\n000000: rs1: RDB$COLLATIONS\n\u0026#x26;lt;...\u0026#x26;gt;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFWIW, I did tested the old protocol on real network with similar latency too. The result was very resemblant.\u003c/p\u003e\n\u003cp\u003eThe total times are:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e\u003c/th\u003e\n\u003cth\u003e\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eOld protocol\u003c/td\u003e\n\u003ctd\u003e55.5s\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNew Protocol\u003c/td\u003e\n\u003ctd\u003e18.5s\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNew Protocol minus round-trip times of rs3\u003c/td\u003e\n\u003ctd\u003e10.1s\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eSo we may see that:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe old protocol is a crap.\u003c/li\u003e\n\u003cli\u003eThe new protocol does a good job removing some \"unnecessary\" round-trips.\u003c/li\u003e\n\u003cli\u003eIt may be improved.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe first interesting problem is the series of statement preparations. The preparation of a statement may result in an error, so it necessary involves a round-trip so we can get the status from the server. But does it \u003cstrong\u003ereally needs\u003c/strong\u003e it? Using Oracle JDBC driver, a prepareStatement with a wrong statement does not throw an exception. It's deferred. In fact, this is a contract, and a change in a contract would require some way for the client applications to enable or disable it.\u003c/p\u003e\n\u003cp\u003eThe second interesting thing is that executing a statement that needs fetch does not involves a round-trip. Does it happens too when selecting from a SP? Won't this be a contract change as well, since selectable SPs could write to the database? I didn't did further tests... Anyway, that's what allows the optimizations I talk below.\u003c/p\u003e\n\u003cp\u003eThen we start the fetches. The first fetch for rs1 necessarily involves a round-trip and buffers some records in the client. Subsequents fetches are resolved locally.\u003c/p\u003e\n\u003cp\u003eThe third interesting thing is about the nested queries. Since queries are executed, a round-trip would be inevitable, but it does one for each query. A more intelligent approach would be to fetch rs3 too when asked to fetch rs2, since it's already executed. In this test, it would run ~8s faster. And a much more intelligent approach would do it in the background (and transmitting asynchronous), without putting some overhead on the rs2 call.\u003c/p\u003e\n\u003cp\u003eWith a super intelligent server/client/protocol, the client and the server may cache prepared statements, and the server may asynchronous send statements invalidations to the client. Then, preparation of statements would have no round-trip (when already prepared one time), being sure that the statement is not wrong.\u003c/p\u003e\n\u003cp\u003eSo what you may do now?\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eDo not talk with the server in this poor (and common) way. Use selectable SPs to run multiple queries.\u003c/li\u003e\n\u003cli\u003eDo not prepare/close/prepare your common statements. Cache them in your application.\u003c/li\u003e\n\u003c/ol\u003e\n","layout":"post","title":"Influence of network latency in the Firebird wire protocol","published":true,"date":"2009-07-12T23:25:00.001-03:00","author":"Adriano dos Santos Fernandes","tags":["firebird"],"modified_time":"2009-07-14T22:35:29.360-03:00"}},"__N_SSG":true},"page":"/[...id]","query":{"id":["2009","07","12","network-latency-influence-on-firebird"]},"buildId":"izhNBcO73VT0YxTF42ALX","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8683bd742a84c1edd48c.js"></script><script src="/_next/static/chunks/webpack-7b93a5f561ae081d75f3.js" async=""></script><script src="/_next/static/chunks/framework-8866fe8c01e4d65da4f2.js" async=""></script><script src="/_next/static/chunks/597-22fbf75857fb562c43e5.js" async=""></script><script src="/_next/static/chunks/main-e746c11fc92907085dc6.js" async=""></script><script src="/_next/static/chunks/pages/_app-90e40cde781992767b75.js" async=""></script><script src="/_next/static/chunks/794-0bc3b9b310bfaef5f98c.js" async=""></script><script src="/_next/static/chunks/pages/%5B...id%5D-7a554f06ecf14fc2fe64.js" async=""></script><script src="/_next/static/izhNBcO73VT0YxTF42ALX/_buildManifest.js" async=""></script><script src="/_next/static/izhNBcO73VT0YxTF42ALX/_ssgManifest.js" async=""></script></body></html>