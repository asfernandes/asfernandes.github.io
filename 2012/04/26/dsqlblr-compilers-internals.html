<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>DSQL/BLR compilers internals</title>
  <meta name="description" content="This post is some raw notes and is not very understandable by people who never worked with this code. In fact, the old implementation was so ugly that it was...">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/bootstrap-social.css">
  <link rel="canonical" href="https://asfernandes.github.io/2012/04/26/dsqlblr-compilers-internals.html">
  <link rel="alternate" type="application/rss+xml" title="asfernandes' blog" href="https://asfernandes.github.io/feed.xml">

  

  
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-7263221-3', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


</head>


	<!-- Start of StatCounter Code for Default Guide -->
	<script type="text/javascript">
	var sc_project=11098306;
	var sc_invisible=1;
	var sc_security="a73f5966";
	var scJsHost = (("https:" == document.location.protocol) ?
	"https://secure." : "http://www.");
	document.write("<sc"+"ript type='text/javascript' src='" +
	scJsHost+
	"statcounter.com/counter/counter.js'></"+"script>");
	</script>
	<noscript><div class="statcounter"><a title="shopify stats"
	href="http://statcounter.com/shopify/" target="_blank"><img
	class="statcounter"
	src="//c.statcounter.com/11098306/0/a73f5966/1/"
	alt="shopify stats"></a></div></noscript>
	<!-- End of StatCounter Code for Default Guide -->



  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://asfernandes.github.io">asfernandes' blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        <li>
          <a href="/contact">contact</a>
        </li>
      

      
        <li>
          <a href="/search" class="nav-search-link" title="Search">
            <span class="fa fa-search nav-search-icon"></span>
            <span class="nav-search-text"></span>
          </a>
        </li>
        
      </ul>
    </div>

  
  <div class="avatar-container">
    <div class="avatar-img-border">
      <a href="https://asfernandes.github.io">
        <img class="avatar-img" src="/img/avatar-icon.png" alt="asfernandes' blog"/>
    </a>
    </div>
  </div>
  

  </div>
</nav>

    <div role="main" class="container main-content">
        <header class="header-post">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <div class="post-heading">
        <h1>DSQL/BLR compilers internals</h1>
        
        <span class="post-meta">Posted on April 26, 2012 in
        
          
          
          <a href="/tag/firebird" class="blog-tags">firebird</a>
        
        </span>
      </div>
     </div>
  </div>
</header>

<article>
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	    This post is some raw notes and is not very understandable by people who never worked with this code. In fact, the old implementation was so ugly that it was not simple even for me (who is constantly working in this area) to achieve this result. It needed many tries and reverts, but IMNSHO ended very well. Also, this was a large work that took many time, and I'm just writing some records here.<br /><br />Back in 2006, just after being invited to take DSQL work, I started to think what would we need to do to improve the compilers (DSQL and BLR) internals. My look started at src/dsql/pass1.cpp and src/jrd/cmp.cpp. Till then, even the addition of a simple function was a nightmare. This dialog happened by Nickolay Samofatov and myself in September-2004:<br /><br />Adriano: I added the "Lower" function. I don't knew that it is so difficult.&nbsp;"Length" will be added using blr too?<br /><br />Nickolay:&nbsp;why difficult? <br /><br />Nickolay:&nbsp;just fix 15 files or so :-) <br /><br />So I spent some years fixing "15 files or so" to add each feature and became very bored. In v2.5, to implement ALTER CHARACTER SET and AUTONOMOUS TRANSACTIONS statements, I added a "compatibility layer" to implement statements in an more OO-way. I described the DDL work in <a href="http://asfernandes.blogspot.com.br/2009/08/ddl-execution-architecture-in-firebird_4841.html">this post</a>. <br /><br />As I had&nbsp;promised&nbsp;in that post, it allowed to implement subroutines, as well packages. <br /><br />Within the v3.0 development cycle started, it was clear that not only statements was needing this layer, but expressions too. Expressions are much more "interesting" than statements. There are many types of expressions, all of them were mangled in the (now removed!) ubiquitous&nbsp;dsql_nod/jrd_nod structures and algorithms. These types are record sources, values, booleans, aggregate values, windowed values and lists. <br /><br />The compatibility expression layer allowed to implement window functions (more <a href="http://asfernandes.blogspot.com.br/2010/01/window-functions_19.html">here</a>, <a href="http://asfernandes.blogspot.com.br/2010/01/window-functions-part2-cumulative_24.html">here</a>&nbsp;and <a href="http://asfernandes.blogspot.com.br/2010/02/window-functions-part3-new-functions.html">here</a>), but at the same time it create more ugly code in the (internal) interfaces. <br /><br />The complete removal of jrd_nod was easy and done a lot of time ago. But dsql_nod remained. It was a lot of code needing a complete refactor (rewrite), which now is finally done. <br /><br />This is the Node classes hierarchy. Except lists, each of them has its inherited classes (omitted here). <br /><br />Node<br />--- DdlNode<br />--- DmlNode<br />------ StmtNode<br />------ ExprNode<br />--------- BoolExprNode<br />--------- ValueExprNode<br />------------ AggNode<br />--------------- WinFuncNode<br />--------- RecordSourceNode<br />--------- ListExprNode<br />------------ ValueListExprNode<br />------------ RecSourceListExprNode<br /><br />As I said, much time was spent on this, but without it many other features were not possible (or viable).<br /><br />It's easy to say now that the old code was a crap (and that is what it was, really!), but many things are involved here (like C vs C++, bison vs btyacc). The main thing is that this rework was now possible, so it was done.
	  </div>
  </div>
</article>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

    
      <!-- Check if any share-links are active -->




<section id = "social-share-section">

  <!--- Share on Twitter -->
  
    <a href="https://twitter.com/intent/tweet?text=https://asfernandes.github.io/2012/04/26/dsqlblr-compilers-internals.html&via=adrianosf"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter"
      data-ga-event=1 data-ga-category="share" data-ga-action="social-twitter" data-ga-label="/2012/04/26/dsqlblr-compilers-internals.html">
      <span class="fa fa-fw fa-twitter" aria-hidden="true"></span>
    </a>
  

  <!--- Share on Facebook -->
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=https://asfernandes.github.io/2012/04/26/dsqlblr-compilers-internals.html"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook"
      data-ga-event=1 data-ga-category="share" data-ga-action="social-facebook" data-ga-label="/2012/04/26/dsqlblr-compilers-internals.html">
      <span class="fa fa-fw fa-facebook" aria-hidden="true"></span>
    </a>
  

  <!--- Share on Google Plus -->
  
    <a href="https://plus.google.com/share?url=https://asfernandes.github.io/2012/04/26/dsqlblr-compilers-internals.html"
      class="btn btn-social-icon btn-google" title="Share on Google+"
      data-ga-event=1 data-ga-category="share" data-ga-action="social-google" data-ga-label="/2012/04/26/dsqlblr-compilers-internals.html">
      <span class="fa fa-fw fa-google-plus" aria-hidden="true"></span>
    </a>
  

  <!--- Share on LinkedIn -->
  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://asfernandes.github.io/2012/04/26/dsqlblr-compilers-internals.html"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn"
      data-ga-event=1 data-ga-category="share" data-ga-action="social-linkedin" data-ga-label="/2012/04/26/dsqlblr-compilers-internals.html">
      <span class="fa fa-fw fa-linkedin" aria-hidden="true"></span>
    </a>
  

</section>



    

    <ul class="pager blog-pager">
      
      <li class="previous">
        <a href="/2011/10/22/como-se-tornar-ou-nao-um-firebird.html" data-toggle="tooltip" data-placement="top" title="Como se tornar (ou nÃ£o) um "Firebird Developer"">&larr; Previous Post</a>
      </li>
      
      
      <li class="next">
        <a href="/2013/12/18/artigo-novidades-do-firebird-25_18.html" data-toggle="tooltip" data-placement="top" title="Artigo "Novidades do Firebird 2.5"">Next Post &rarr;</a>
      </li>
      
    </ul>
  </div>
</div>


<div class="row disqus-comments">
  <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    var disqus_shortname = 'asfernandes-blog';
	    // ensure that pages with query string get the same discussion
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];	    
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


  </div>
</div>


    </div>
    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/asfernandes" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
      
          <li>
            <a href="https://twitter.com/adrianosf" title="Twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
      
          <li>
            <a href="mailto:adrianosf@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
      
          <li>
            <a href="https://linkedin.com/in/adrianosf" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
      
      
      <li>
      <a href="/feed.xml" title="RSS">
        <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
        </span>
      </a>
      </li>   
               
        </ul>
        <p class="copyright text-muted">
      Adriano dos Santos Fernandes
      &nbsp;&bull;&nbsp;
      2017
      
      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
    







    
  </body>
</html>
